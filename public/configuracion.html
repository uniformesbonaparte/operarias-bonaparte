<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>‚öôÔ∏è Configuraci√≥n ¬∑ Uniformes Bonaparte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="icon" type="image/png" sizes="32x32" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0E0F12">

  <style>
    :root {
      --bg-dark: #0a0e27;
      --bg-darker: #050811;
      --glass: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 100%);
      color: var(--text-main);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before, body::after {
      content: '';
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
    }

    body::before {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
      top: -250px;
      right: -250px;
      animation: float 8s ease-in-out infinite;
    }

    body::after {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(16, 185, 129, 0.15) 0%, transparent 70%);
      bottom: -200px;
      left: -200px;
      animation: float 10s ease-in-out infinite reverse;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
    }

    .shell {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 24px;
      position: relative;
      z-index: 1;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding: 16px 20px;
      border-radius: 20px;
      background: var(--glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .btn-back {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.3);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 20px;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(-2px);
    }

    .header-info h1 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 2px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-info span {
      font-size: 13px;
      color: var(--text-muted);
    }

    main {
      padding-bottom: 40px;
    }

    .card {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid var(--glass-border);
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      margin-bottom: 16px;
      animation: fadeInUp 0.5s ease-out backwards;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.15s; }
    .card:nth-child(3) { animation-delay: 0.2s; }
    .card:nth-child(4) { animation-delay: 0.25s; }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subtext {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-card {
      background: rgba(0, 0, 0, 0.3);
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .stat-card .label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .valor {
      font-size: 28px;
      font-weight: 700;
      color: var(--success);
    }

    .maquina-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .maquina-nombre {
      font-size: 14px;
      font-weight: 600;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.3);
      color: var(--text-main);
      font-size: 14px;
      outline: none;
      transition: all 0.3s;
    }

    input:focus {
      border-color: var(--success);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .btn-primary {
      padding: 12px 20px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-secondary {
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid var(--glass-border);
      background: rgba(59, 130, 246, 0.2);
      color: #93c5fd;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      background: rgba(59, 130, 246, 0.3);
    }

    .btn-danger {
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid var(--glass-border);
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    .comparacion-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .comparacion-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .comparacion-titulo {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--success);
    }

    .comparacion-stat {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .comparacion-stat strong {
      color: var(--text-main);
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <button class="btn-back" id="btn-volver">‚Üê</button>
      <div class="header-info">
        <h1>‚öôÔ∏è Configuraci√≥n</h1>
        <span>Administraci√≥n del sistema</span>
      </div>
    </header>

    <main>
      <!-- Estad√≠sticas Generales -->
      <section class="card">
        <div class="card-title">üìä Estad√≠sticas del Sistema</div>
        <p class="subtext">Resumen general de la aplicaci√≥n</p>
        
        <div class="stat-grid" id="stats-container">
          <div class="stat-card">
            <div class="label">Operarias Activas</div>
            <div class="valor" id="stat-operarias">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Pedidos Activos</div>
            <div class="valor" id="stat-pedidos">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Piezas Producidas</div>
            <div class="valor" id="stat-piezas">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Total Pendiente</div>
            <div class="valor" style="font-size: 20px;">$<span id="stat-total">0</span></div>
          </div>
        </div>
      </section>

      <!-- Gesti√≥n de M√°quinas -->
      <section class="card">
        <div class="card-title">üîß Gesti√≥n de M√°quinas</div>
        <p class="subtext">Agregar o eliminar m√°quinas del sistema</p>
        
        <div id="maquinas-lista"></div>
        
        <div class="form-row">
          <input type="text" id="input-nueva-maquina" placeholder="Nombre de la m√°quina" />
          <button class="btn-primary" id="btn-agregar-maquina">‚ûï Agregar</button>
        </div>
      </section>

      <!-- Comparaci√≥n de Fuentes -->
      <section class="card">
        <div class="card-title">üìà Comparaci√≥n: Operarias vs Encargada</div>
        <p class="subtext">Producci√≥n pendiente por fuente</p>
        
        <div class="comparacion-grid" id="comparacion-container">
          <div class="comparacion-item">
            <div class="comparacion-titulo">üë• Operarias</div>
            <div class="comparacion-stat">Piezas: <strong id="comp-op-piezas">0</strong></div>
            <div class="comparacion-stat">Ganado: <strong>$<span id="comp-op-ganado">0</span></strong></div>
            <div class="comparacion-stat">Registros: <strong id="comp-op-regs">0</strong></div>
          </div>
          <div class="comparacion-item">
            <div class="comparacion-titulo">üë§ Encargada</div>
            <div class="comparacion-stat">Piezas: <strong id="comp-enc-piezas">0</strong></div>
            <div class="comparacion-stat">Ganado: <strong>$<span id="comp-enc-ganado">0</span></strong></div>
            <div class="comparacion-stat">Registros: <strong id="comp-enc-regs">0</strong></div>
          </div>
        </div>
      </section>

      <!-- Respaldo de Datos -->
      <section class="card">
        <div class="card-title">üíæ Respaldo de Datos</div>
        <p class="subtext">Crear backup manual del sistema</p>
        
        <button class="btn-primary" id="btn-backup" style="width: 100%;">
          üì¶ Crear Backup Ahora
        </button>
        
        <div style="margin-top: 12px; font-size: 12px; color: var(--text-muted); text-align: center;">
          El backup se guardar√° en el servidor con la fecha y hora actual
        </div>
      </section>

      <!-- Cambiar Credenciales -->
      <section class="card">
        <div class="card-title">üîê Cambiar Credenciales</div>
        <p class="subtext">Modificar usuarios y contrase√±as de Admin y Encargada</p>
        
        <div style="margin-bottom: 20px;">
          <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--success);">üë§ Admin</h3>
          <div class="form-row">
            <input type="text" id="input-admin-usuario" placeholder="Nuevo usuario Admin" />
          </div>
          <div class="form-row">
            <input type="password" id="input-admin-password" placeholder="Nueva contrase√±a Admin" />
          </div>
          <button class="btn-primary" id="btn-cambiar-admin" style="width: 100%;">
            üíæ Actualizar Admin
          </button>
        </div>

        <div>
          <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--accent);">üë• Encargada</h3>
          <div class="form-row">
            <input type="text" id="input-encargada-usuario" placeholder="Nuevo usuario Encargada" />
          </div>
          <div class="form-row">
            <input type="password" id="input-encargada-password" placeholder="Nueva contrase√±a Encargada" />
          </div>
          <button class="btn-primary" id="btn-cambiar-encargada" style="width: 100%;">
            üíæ Actualizar Encargada
          </button>
        </div>
      </section>

      <!-- Gesti√≥n de Prendas -->
      <section class="card">
        <div class="card-title">üß• Gesti√≥n de Prendas</div>
        <p class="subtext">Administra el cat√°logo de prendas del sistema</p>
        
        <div id="prendas-lista"></div>
        
        <div class="form-row">
          <input type="text" id="input-nueva-prenda" placeholder="Nombre de la nueva prenda" />
          <button class="btn-primary" id="btn-agregar-prenda">‚ûï Agregar</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Validar sesi√≥n de admin
      let usuarioActual;
      try {
        const dataUsuario = localStorage.getItem("usuarioActual");
        if (!dataUsuario) throw new Error("No hay sesi√≥n");
        usuarioActual = JSON.parse(dataUsuario);
        
        if (usuarioActual.tipo !== "admin") {
          alert("‚õî Acceso denegado. Solo para administradores.");
          window.location.href = "/dashboard";
          return;
        }
      } catch (err) {
        console.error("Error de sesi√≥n:", err);
        window.location.href = "/login.html";
        return;
      }

      // Cargar todas las secciones
      await cargarEstadisticas();
      await cargarMaquinas();
      await cargarComparacion();
      await cargarPrendas();

      // Event listeners
      document.getElementById("btn-agregar-maquina").addEventListener("click", agregarMaquina);
      document.getElementById("btn-agregar-prenda").addEventListener("click", agregarPrenda);
      document.getElementById("btn-backup").addEventListener("click", crearBackup);
      document.getElementById("btn-volver").addEventListener("click", () => {
        window.location.href = "/dashboard";
      });

      // Cargar estad√≠sticas generales
      async function cargarEstadisticas() {
        try {
          const res = await fetch("/api/estadisticas/general");
          if (!res.ok) throw new Error("Error al cargar estad√≠sticas");
          
          const data = await res.json();
          
          document.getElementById("stat-operarias").textContent = data.operarias.activas;
          document.getElementById("stat-pedidos").textContent = data.pedidos.activos;
          document.getElementById("stat-piezas").textContent = data.produccionPendiente.piezasTotales;
          document.getElementById("stat-total").textContent = data.produccionPendiente.totalGanado.toFixed(0);
        } catch (err) {
          console.error("Error cargando estad√≠sticas:", err);
        }
      }

      // Cargar m√°quinas
      async function cargarMaquinas() {
        try {
          const res = await fetch("/api/maquinas");
          if (!res.ok) throw new Error("Error al cargar m√°quinas");
          
          const maquinas = await res.json();
          const lista = document.getElementById("maquinas-lista");
          
          if (maquinas.length === 0) {
            lista.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No hay m√°quinas registradas</p>';
            return;
          }
          
          lista.innerHTML = maquinas.map(m => `
            <div class="maquina-item">
              <span class="maquina-nombre">üîß ${m}</span>
              <button class="btn-danger" onclick="eliminarMaquina('${m}')">üóëÔ∏è Eliminar</button>
            </div>
          `).join("");
        } catch (err) {
          console.error("Error cargando m√°quinas:", err);
        }
      }

      // Agregar m√°quina
      async function agregarMaquina() {
        const input = document.getElementById("input-nueva-maquina");
        const nombre = input.value.trim();
        
        if (!nombre) {
          alert("‚ö†Ô∏è Escribe el nombre de la m√°quina");
          return;
        }

        try {
          const res = await fetch("/api/maquinas", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nombre })
          });

          if (!res.ok) throw new Error("Error al agregar m√°quina");

          alert("‚úÖ M√°quina agregada correctamente");
          input.value = "";
          await cargarMaquinas();
        } catch (err) {
          alert("‚ùå " + err.message);
        }
      }

      // Eliminar m√°quina
      window.eliminarMaquina = async function(nombre) {
        if (!confirm(`¬øEliminar la m√°quina "${nombre}"?`)) return;

        try {
          const res = await fetch(`/api/maquinas/${encodeURIComponent(nombre)}`, {
            method: "DELETE"
          });

          if (!res.ok) throw new Error("Error al eliminar m√°quina");

          alert("‚úÖ M√°quina eliminada");
          await cargarMaquinas();
        } catch (err) {
          alert("‚ùå " + err.message);
        }
      };

      // Cargar comparaci√≥n de fuentes
      async function cargarComparacion() {
        try {
          const res = await fetch("/api/estadisticas/comparacion-fuentes?estadoPago=pendiente");
          if (!res.ok) throw new Error("Error al cargar comparaci√≥n");
          
          const data = await res.json();
          
          document.getElementById("comp-op-piezas").textContent = data.operarias.piezas;
          document.getElementById("comp-op-ganado").textContent = data.operarias.ganado.toFixed(2);
          document.getElementById("comp-op-regs").textContent = data.operarias.registros;
          
          document.getElementById("comp-enc-piezas").textContent = data.encargada.piezas;
          document.getElementById("comp-enc-ganado").textContent = data.encargada.ganado.toFixed(2);
          document.getElementById("comp-enc-regs").textContent = data.encargada.registros;
        } catch (err) {
          console.error("Error cargando comparaci√≥n:", err);
        }
      }

      // Cargar prendas
      async function cargarPrendas() {
        try {
          const res = await fetch("/api/prendas");
          if (!res.ok) throw new Error("Error al cargar prendas");
          const prendas = await res.json();

          const listaPrendas = document.getElementById("prendas-lista");
          
          if (prendas.length === 0) {
            listaPrendas.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No hay prendas registradas</p>';
            return;
          }

          listaPrendas.innerHTML = prendas.map(p => `
            <div class="maquina-item">
              <span class="maquina-nombre">${p.nombre}</span>
              <button class="btn-danger" onclick="eliminarPrenda(${p.id})">üóëÔ∏è</button>
            </div>
          `).join("");
        } catch (err) {
          console.error("Error cargando prendas:", err);
        }
      }

      // Agregar prenda
      async function agregarPrenda() {
        const nombre = document.getElementById("input-nueva-prenda").value.trim();

        if (!nombre) {
          alert("‚ùå Ingresa el nombre de la prenda");
          return;
        }

        try {
          const res = await fetch("/api/prendas", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nombre })
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || "Error al agregar");
          }

          document.getElementById("input-nueva-prenda").value = "";
          alert("‚úÖ Prenda agregada correctamente");
          await cargarPrendas();
        } catch (err) {
          alert("‚ùå " + err.message);
        }
      }

      // Eliminar prenda (global)
      window.eliminarPrenda = async function(id) {
        if (!confirm("¬øEliminar esta prenda? Los registros antiguos conservar√°n esta prenda, pero no estar√° disponible para nuevos pedidos.")) return;

        try {
          const res = await fetch(`/api/prendas/${id}`, {
            method: "DELETE"
          });

          if (!res.ok) {
            const data = await res.json();
            throw new Error(data.error || "Error al eliminar");
          }

          alert("‚úÖ Prenda eliminada");
          await cargarPrendas();
        } catch (err) {
          alert("‚ùå " + err.message);
        }
      };

      // Crear backup
      async function crearBackup() {
        if (!confirm("¬øCrear un backup de los datos del sistema?")) return;

        const btn = document.getElementById("btn-backup");
        btn.disabled = true;
        btn.textContent = "‚è≥ Creando backup...";

        try {
          const res = await fetch("/api/configuracion/backup", {
            method: "POST"
          });

          const data = await res.json();

          if (data.ok) {
            alert(`‚úÖ Backup creado exitosamente\n\nArchivo: ${data.archivo}`);
          } else {
            throw new Error(data.mensaje || "Error al crear backup");
          }
        } catch (err) {
          alert("‚ùå " + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = "üì¶ Crear Backup Ahora";
        }
      }

      // Cambiar credenciales de Admin
      document.getElementById("btn-cambiar-admin").addEventListener("click", async () => {
        const usuario = document.getElementById("input-admin-usuario").value.trim();
        const password = document.getElementById("input-admin-password").value.trim();

        if (!usuario && !password) {
          alert("‚ùå Ingresa al menos un campo para actualizar");
          return;
        }

        if (!confirm("¬øEst√°s seguro de cambiar las credenciales de Admin?")) return;

        const btn = document.getElementById("btn-cambiar-admin");
        btn.disabled = true;
        btn.textContent = "‚è≥ Actualizando...";

        try {
          const body = {};
          if (usuario) body.nombre = usuario;
          if (password) body.password = password;

          const res = await fetch("/api/usuarios/admin", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });

          const data = await res.json();

          if (!res.ok) throw new Error(data.error || "Error al actualizar");

          alert("‚úÖ Credenciales de Admin actualizadas correctamente");
          
          // Limpiar campos
          document.getElementById("input-admin-usuario").value = "";
          document.getElementById("input-admin-password").value = "";

          // Si cambi√≥ el nombre, actualizar sesi√≥n
          if (usuario) {
            usuarioActual.nombre = usuario;
            localStorage.setItem("usuarioActual", JSON.stringify(usuarioActual));
          }

        } catch (err) {
          alert("‚ùå " + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = "üíæ Actualizar Admin";
        }
      });

      // Cambiar credenciales de Encargada
      document.getElementById("btn-cambiar-encargada").addEventListener("click", async () => {
        const usuario = document.getElementById("input-encargada-usuario").value.trim();
        const password = document.getElementById("input-encargada-password").value.trim();

        if (!usuario && !password) {
          alert("‚ùå Ingresa al menos un campo para actualizar");
          return;
        }

        if (!confirm("¬øEst√°s seguro de cambiar las credenciales de Encargada?")) return;

        const btn = document.getElementById("btn-cambiar-encargada");
        btn.disabled = true;
        btn.textContent = "‚è≥ Actualizando...";

        try {
          const body = {};
          if (usuario) body.nombre = usuario;
          if (password) body.password = password;

          const res = await fetch("/api/usuarios/encargada", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });

          const data = await res.json();

          if (!res.ok) throw new Error(data.error || "Error al actualizar");

          alert("‚úÖ Credenciales de Encargada actualizadas correctamente");
          
          // Limpiar campos
          document.getElementById("input-encargada-usuario").value = "";
          document.getElementById("input-encargada-password").value = "";

        } catch (err) {
          alert("‚ùå " + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = "üíæ Actualizar Encargada";
        }
      });
    });
  </script>
</body>
</html>
