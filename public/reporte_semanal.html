<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üìä Reporte Semanal ¬∑ Bonaparte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="icon" type="image/png" sizes="32x32" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0E0F12">

  <style>
    :root {
      --bg-dark: #0a0e27;
      --bg-darker: #050811;
      --glass: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 100%);
      color: var(--text-main);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before, body::after {
      content: '';
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
    }

    body::before {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
      top: -250px;
      right: -250px;
      animation: float 8s ease-in-out infinite;
    }

    body::after {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(245, 158, 11, 0.15) 0%, transparent 70%);
      bottom: -200px;
      left: -200px;
      animation: float 10s ease-in-out infinite reverse;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
    }

    .shell {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 24px;
      position: relative;
      z-index: 1;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding: 16px 20px;
      border-radius: 20px;
      background: var(--glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .btn-back {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.3);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 20px;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(-2px);
    }

    .header-info h1 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 2px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-info span {
      font-size: 13px;
      color: var(--text-muted);
    }

    main {
      padding-bottom: 40px;
    }

    .card {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid var(--glass-border);
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subtext {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.3);
      color: var(--text-main);
      font-size: 15px;
      outline: none;
      transition: all 0.3s;
    }

    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: rgba(0, 0, 0, 0.4);
    }

    .radio-group {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .radio-option input[type="radio"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .radio-option label {
      cursor: pointer;
      margin: 0;
      text-transform: none;
      letter-spacing: 0;
      font-size: 14px;
    }

    .btn-primary {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: linear-gradient(135deg, var(--accent), #2563eb);
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--glass-border);
      background: rgba(59, 130, 246, 0.2);
      color: #93c5fd;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      background: rgba(59, 130, 246, 0.3);
    }

    .btn-success {
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--glass-border);
      background: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-success:hover {
      background: rgba(16, 185, 129, 0.3);
    }

    .operaria-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 12px;
    }

    .operaria-nombre {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .operaria-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin: 12px 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .operaria-stats strong {
      color: var(--text-main);
    }

    .operaria-acciones {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .total-general {
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.3);
      padding: 16px;
      border-radius: 14px;
      text-align: center;
      margin: 16px 0;
    }

    .total-general-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .total-general-valor {
      font-size: 24px;
      font-weight: 700;
      color: var(--success);
    }

    .mensaje-error, .mensaje-exito {
      padding: 12px 16px;
      border-radius: 14px;
      margin-bottom: 16px;
      display: none;
      font-size: 13px;
    }

    .mensaje-error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }

    .mensaje-exito {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #6ee7b7;
    }

    .oculto {
      display: none !important;
    }

    .no-print {
      /* Ocultar en impresi√≥n */
    }

    /* Modal de detalle */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-detalle {
      background: var(--card-bg);
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: var(--bg-color);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .detalle-dia {
      margin-bottom: 24px;
    }

    .detalle-dia-titulo {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border-color);
    }

    .detalle-registro {
      background: var(--bg-color);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
    }

    .detalle-registro-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .detalle-escuela {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 15px;
    }

    .detalle-prenda {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 4px;
    }

    .detalle-descripcion {
      color: var(--text-secondary);
      font-size: 14px;
      font-style: italic;
      margin-bottom: 8px;
    }

    .detalle-calculo {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(59, 130, 246, 0.08);
      border-radius: 8px;
      margin-top: 8px;
    }

    .detalle-cantidad {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .detalle-total {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 16px;
    }

    .detalle-subtotal {
      text-align: right;
      padding: 12px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 16px;
      border-top: 2px solid var(--border-color);
      margin-top: 8px;
    }

    .detalle-total-general {
      background: rgba(59, 130, 246, 0.15);
      border: 2px solid var(--primary-color);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin-top: 24px;
    }

    .detalle-total-general-label {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .detalle-total-general-valor {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary-color);
    }

    @media print {
      body {
        background: white;
      }
      
      .no-print, header, .btn-back {
        display: none !important;
      }
      
      .shell {
        max-width: 100%;
        padding: 0;
      }
      
      .card {
        background: white;
        box-shadow: none;
        border: 1px solid #ccc;
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="no-print">
      <button class="btn-back" id="btn-volver">‚Üê</button>
      <div class="header-info">
        <h1>üìä Reporte Semanal</h1>
        <span>Usuario: <strong id="nombre-usuario"></strong></span>
      </div>
    </header>

    <main>
      <div class="mensaje-error" id="mensaje-error"></div>
      <div class="mensaje-exito" id="mensaje-exito"></div>

      <!-- Filtros -->
      <section class="card no-print">
        <div class="card-title">üîç Filtros de Consulta</div>
        <p class="subtext">Selecciona c√≥mo deseas consultar</p>

        <div class="radio-group">
          <div class="radio-option">
            <input type="radio" id="tipo-dia" name="tipo-consulta" value="dia" />
            <label for="tipo-dia">Por D√≠a</label>
          </div>
          <div class="radio-option">
            <input type="radio" id="tipo-semana" name="tipo-consulta" value="semana" checked />
            <label for="tipo-semana">Por Semana</label>
          </div>
        </div>

        <!-- Filtro por d√≠a -->
        <div id="filtro-dia" class="oculto">
          <div class="form-row">
            <label for="input-fecha">üìÖ Fecha</label>
            <input type="date" id="input-fecha" />
          </div>
        </div>

        <!-- Filtro por semana -->
        <div id="filtro-semana">
          <div class="form-row">
            <label for="select-semana">üìÖ Semana</label>
            <select id="select-semana">
              <option value="">-- Selecciona una semana --</option>
            </select>
          </div>
          
          <div class="form-row" id="filtro-estado-container">
            <label for="select-estado-pago">üí∞ Estado de Pago</label>
            <select id="select-estado-pago">
              <option value="pendiente">Pendientes</option>
              <option value="pagado">Pagadas</option>
              <option value="todos">Todas</option>
            </select>
          </div>

          <!-- Filtro de operaria (solo admin) -->
          <div class="form-row" id="filtro-operaria-container">
            <label for="select-operaria-filtro">üë§ Operaria</label>
            <select id="select-operaria-filtro">
              <option value="">-- Todas las operarias --</option>
            </select>
          </div>

          <!-- Filtro de fuente/base de datos (solo admin) -->
          <div class="form-row" id="filtro-fuente-container">
            <label for="select-fuente">üìä Base de Datos</label>
            <select id="select-fuente">
              <option value="todos">Ambas (Operarias + Encargada)</option>
              <option value="operaria">Solo Operarias</option>
              <option value="encargada">Solo Encargada</option>
            </select>
          </div>
        </div>

        <button class="btn-primary" id="btn-consultar">üîç Consultar</button>
      </section>

      <!-- Acciones globales (solo admin) -->
      <section class="card no-print oculto" id="acciones-globales">
        <div style="display: flex; gap: 8px; flex-direction: column;">
          <button class="btn-secondary" id="btn-imprimir-todos">üñ®Ô∏è Imprimir Todos los Recibos</button>
          <button class="btn-warning" id="btn-marcar-pagado">üí∞ Marcar TODAS como Pagadas</button>
        </div>
      </section>

      <!-- Resultados -->
      <section class="card">
        <div class="card-title">üìã Resultados</div>
        <p class="subtext" id="subtext-resultados">Consulta los reportes</p>
        
        <div id="total-general-container" class="oculto">
          <div class="total-general">
            <div class="total-general-label">Total a Pagar</div>
            <div class="total-general-valor" id="total-general">$0.00</div>
          </div>
        </div>

        <div id="lista-resultados"></div>
      </section>
    </main>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Validar sesi√≥n
      let usuarioActual;
      try {
        const dataUsuario = localStorage.getItem("usuarioActual");
        if (!dataUsuario) throw new Error("No hay sesi√≥n");
        usuarioActual = JSON.parse(dataUsuario);
        if (!usuarioActual.tipo || !usuarioActual.nombre) throw new Error("Sesi√≥n inv√°lida");
      } catch (err) {
        console.error("Error de sesi√≥n:", err);
        localStorage.removeItem("usuarioActual");
        alert("Sesi√≥n inv√°lida. Por favor inicia sesi√≥n nuevamente.");
        window.location.href = "/login.html";
        return;
      }

      const esAdmin = usuarioActual.tipo === "admin";
      const esOperaria = usuarioActual.tipo === "operaria";
      const esEncargada = usuarioActual.tipo === "encargada";

      // Elementos DOM
      const spanNombreUsuario = document.getElementById("nombre-usuario");
      const tipoDia = document.getElementById("tipo-dia");
      const tipoSemana = document.getElementById("tipo-semana");
      const filtroDia = document.getElementById("filtro-dia");
      const filtroSemana = document.getElementById("filtro-semana");
      const inputFecha = document.getElementById("input-fecha");
      const selectSemana = document.getElementById("select-semana");
      const selectEstadoPago = document.getElementById("select-estado-pago");
      const selectOperariaFiltro = document.getElementById("select-operaria-filtro");
      const selectFuente = document.getElementById("select-fuente");
      const btnConsultar = document.getElementById("btn-consultar");
      const listaResultados = document.getElementById("lista-resultados");
      const subtextResultados = document.getElementById("subtext-resultados");
      const totalGeneralContainer = document.getElementById("total-general-container");
      const totalGeneralValor = document.getElementById("total-general");
      const accionesGlobales = document.getElementById("acciones-globales");
      const filtroEstadoContainer = document.getElementById("filtro-estado-container");
      const filtroOperariaContainer = document.getElementById("filtro-operaria-container");
      const filtroFuenteContainer = document.getElementById("filtro-fuente-container");
      const mensajeError = document.getElementById("mensaje-error");
      const mensajeExito = document.getElementById("mensaje-exito");

      if (spanNombreUsuario) spanNombreUsuario.textContent = usuarioActual.nombre || "";

      // Fecha de hoy por defecto
      const hoy = new Date().toISOString().split('T')[0];
      inputFecha.value = hoy;

      // Mostrar/ocultar filtros seg√∫n rol
      if (esOperaria) {
        // Operarias S√ç pueden ver el filtro de estado (pendientes/pagadas)
        // pero NO ven filtros de operaria ni fuente
        filtroOperariaContainer.classList.add("oculto");
        filtroFuenteContainer.classList.add("oculto");
      } else if (esEncargada) {
        filtroOperariaContainer.classList.add("oculto");
        filtroFuenteContainer.classList.add("oculto");
      } else if (esAdmin) {
        // Admin ve todos los filtros
        cargarOperariasParaFiltro();
      }

      // Cambiar entre d√≠a/semana
      tipoDia.addEventListener("change", () => {
        if (tipoDia.checked) {
          filtroDia.classList.remove("oculto");
          filtroSemana.classList.add("oculto");
        }
      });

      tipoSemana.addEventListener("change", () => {
        if (tipoSemana.checked) {
          filtroDia.classList.add("oculto");
          filtroSemana.classList.remove("oculto");
          cargarSemanas();
        }
      });

      // Cargar semanas disponibles
      async function cargarSemanas() {
        try {
          const estado = selectEstadoPago.value;
          const res = await fetch(`/api/semanas?estado=${estado}`);
          if (!res.ok) throw new Error("Error al cargar semanas");
          
          const semanas = await res.json();
          
          selectSemana.innerHTML = '<option value="">-- Selecciona una semana --</option>';
          
          semanas.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s.codigo;
            opt.textContent = `${s.codigo} (${formatearFecha(s.inicio)} - ${formatearFecha(s.fin)}) - $${s.totalPagar.toFixed(2)}`;
            selectSemana.appendChild(opt);
          });

        } catch (err) {
          mostrarError("Error cargando semanas: " + err.message);
        }
      }

      // Cargar operarias para filtro (solo admin)
      async function cargarOperariasParaFiltro() {
        try {
          const res = await fetch("/api/operarias");
          if (!res.ok) throw new Error("Error al cargar operarias");
          
          const operarias = await res.json();
          
          selectOperariaFiltro.innerHTML = '<option value="">-- Todas las operarias --</option>';
          
          operarias.filter(op => op.activa).forEach(op => {
            const opt = document.createElement("option");
            opt.value = op.id;
            opt.textContent = op.nombre;
            selectOperariaFiltro.appendChild(opt);
          });

        } catch (err) {
          console.error("Error cargando operarias:", err);
        }
      }

      // Consultar
      btnConsultar.addEventListener("click", async () => {
        const tipoBusqueda = tipoDia.checked ? 'dia' : 'semana';
        
        if (tipoBusqueda === 'dia') {
          await consultarPorDia();
        } else {
          await consultarPorSemana();
        }
      });

      // Consultar por d√≠a
      async function consultarPorDia() {
        const fecha = inputFecha.value;
        
        if (!fecha) {
          mostrarError("‚ùå Selecciona una fecha");
          return;
        }

        try {
          let url = `/api/registros?fecha=${fecha}&estadoPago=pendiente`;
          
          if (esOperaria) {
            url += `&operariaId=${usuarioActual.id}`;
          } else if (esAdmin) {
            // Filtro de operaria
            const operariaId = selectOperariaFiltro.value;
            if (operariaId) {
              url += `&operariaId=${operariaId}`;
            }
            
            // Filtro de fuente/base de datos
            const fuente = selectFuente.value;
            if (fuente !== 'todos') {
              url += `&fuente=${fuente}`;
            }
          }

          const res = await fetch(url);
          if (!res.ok) throw new Error("Error al consultar");
          
          const registros = await res.json();
          mostrarResultadosDia(registros, fecha);

        } catch (err) {
          mostrarError("Error: " + err.message);
        }
      }

      // Consultar por semana
      async function consultarPorSemana() {
        const semanaCodigo = selectSemana.value;
        
        if (!semanaCodigo) {
          mostrarError("‚ùå Selecciona una semana");
          return;
        }

        try {
          const estado = selectEstadoPago.value;
          let url = `/api/reporte-semanal?semana=${semanaCodigo}&estado=${estado}`;
          
          // Agregar filtros de admin
          if (esAdmin) {
            const operariaId = selectOperariaFiltro.value;
            if (operariaId) {
              url += `&operariaId=${operariaId}`;
            }
            
            const fuente = selectFuente.value;
            if (fuente !== 'todos') {
              url += `&fuente=${fuente}`;
            }
          }
          
          const res = await fetch(url);
          
          if (!res.ok) throw new Error("Error al consultar");
          
          const data = await res.json();
          
          if (esOperaria) {
            // Filtrar solo la operaria actual
            const misDatos = data.find(d => d.operariaId === usuarioActual.id);
            mostrarResultadoOperaria(misDatos, semanaCodigo);
          } else {
            mostrarResultadosAdmin(data, semanaCodigo, estado);
          }

        } catch (err) {
          mostrarError("Error: " + err.message);
        }
      }

      // Mostrar resultados por d√≠a
      function mostrarResultadosDia(registros, fecha) {
        subtextResultados.textContent = `Resultados del ${formatearFecha(fecha)}`;
        accionesGlobales.classList.add("oculto");
        totalGeneralContainer.classList.add("oculto");

        if (registros.length === 0) {
          listaResultados.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No hay registros en esta fecha</p>';
          return;
        }

        if (esOperaria) {
          const total = registros.reduce((sum, r) => sum + r.totalGanado, 0);
          const piezas = registros.reduce((sum, r) => sum + r.cantidad, 0);

          listaResultados.innerHTML = `
            <div class="operaria-item">
              <div class="operaria-nombre">üìä Resumen del D√≠a</div>
              <div class="operaria-stats">
                <div>üì¶ Piezas: <strong>${piezas}</strong></div>
                <div>üí∞ Total: <strong>$${total.toFixed(2)}</strong></div>
              </div>
              <div style="margin-top: 12px;">
                ${registros.map(r => `
                  <div style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px; font-size: 13px;">
                    <strong>${r.escuela}</strong><br>
                    ${r.descripcion} | ${r.cantidad} pzs √ó $${r.pagoPorPieza.toFixed(2)} = $${r.totalGanado.toFixed(2)}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        } else {
          // Admin/Encargada: agrupar por operaria
          const porOperaria = {};
          
          registros.forEach(r => {
            if (!porOperaria[r.operariaId]) {
              porOperaria[r.operariaId] = {
                nombre: r.operariaNombre,
                piezas: 0,
                total: 0,
                registros: []
              };
            }
            
            porOperaria[r.operariaId].piezas += r.cantidad;
            porOperaria[r.operariaId].total += r.totalGanado;
            porOperaria[r.operariaId].registros.push(r);
          });

          const totalGeneral = Object.values(porOperaria).reduce((sum, op) => sum + op.total, 0);
          totalGeneralValor.textContent = `$${totalGeneral.toFixed(2)}`;
          totalGeneralContainer.classList.remove("oculto");

          listaResultados.innerHTML = Object.values(porOperaria).map(op => `
            <div class="operaria-item">
              <div class="operaria-nombre">üë§ ${op.nombre}</div>
              <div class="operaria-stats">
                <div>üì¶ Piezas: <strong>${op.piezas}</strong></div>
                <div>üí∞ Total: <strong>$${op.total.toFixed(2)}</strong></div>
              </div>
            </div>
          `).join('');
        }
      }

      // Mostrar resultado de operaria (semana)
      function mostrarResultadoOperaria(datos, semanaCodigo) {
        const estadoTexto = selectEstadoPago.value === 'pendiente' ? 'Pendiente' : 
                           selectEstadoPago.value === 'pagado' ? 'Pagada' : 'Total';
        subtextResultados.textContent = `Semana ${semanaCodigo} - ${estadoTexto}`;
        accionesGlobales.classList.add("oculto");
        totalGeneralContainer.classList.add("oculto");

        if (!datos || datos.piezas === 0) {
          listaResultados.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No tienes registros en esta semana</p>';
          return;
        }

        listaResultados.innerHTML = `
          <div class="operaria-item">
            <div class="operaria-nombre">üìä Tu Resumen Semanal</div>
            <div class="operaria-stats">
              <div>üì¶ Piezas: <strong>${datos.piezas}</strong></div>
              <div>üí∞ Total: <strong>$${datos.ganado.toFixed(2)}</strong></div>
              <div>üìä Registros: <strong>${datos.registros}</strong></div>
            </div>
            <div class="operaria-acciones">
              <button class="btn-secondary" onclick="verDetalleRegistros(${datos.operariaId}, '${datos.nombre}', '${semanaCodigo}')">
                üìã Ver Detalle
              </button>
            </div>
          </div>
        `;
      }

      // Mostrar resultados admin (semana)
      function mostrarResultadosAdmin(datos, semanaCodigo, estado) {
        subtextResultados.textContent = `Semana ${semanaCodigo} - ${estado === 'pendiente' ? 'Pendientes' : estado === 'pagado' ? 'Pagadas' : 'Todas'}`;
        
        if (datos.length === 0) {
          listaResultados.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No hay registros</p>';
          accionesGlobales.classList.add("oculto");
          totalGeneralContainer.classList.add("oculto");
          return;
        }

        const totalGeneral = datos.reduce((sum, op) => sum + op.ganado, 0);
        totalGeneralValor.textContent = `$${totalGeneral.toFixed(2)}`;
        totalGeneralContainer.classList.remove("oculto");

        // Mostrar acciones solo si es admin y hay pendientes
        if (esAdmin && estado === 'pendiente') {
          accionesGlobales.classList.remove("oculto");
        } else {
          accionesGlobales.classList.add("oculto");
        }

        listaResultados.innerHTML = datos.map(op => `
          <div class="operaria-item">
            <div class="operaria-nombre">üë§ ${op.nombre}</div>
            <div class="operaria-stats">
              <div>üì¶ Piezas: <strong>${op.piezas}</strong></div>
              <div>üí∞ Total: <strong>$${op.ganado.toFixed(2)}</strong></div>
              <div>üìä Registros: <strong>${op.registros}</strong></div>
            </div>
            ${esAdmin ? `
              <div class="operaria-acciones">
                <button class="btn-secondary" onclick="verDetalleRegistros(${op.operariaId}, '${op.nombre}', '${semanaCodigo}')">
                  üìã Ver Detalle
                </button>
                <button class="btn-secondary" onclick="imprimirRecibo(${op.operariaId}, '${semanaCodigo}')">
                  üñ®Ô∏è Imprimir Recibo
                </button>
                ${estado === 'pendiente' ? `
                  <button class="btn-success" onclick="marcarOperariaPagada(${op.operariaId}, '${op.nombre}', '${semanaCodigo}', ${op.ganado})">
                    üí∞ Marcar Pagada
                  </button>
                ` : ''}
              </div>
            ` : ''}
          </div>
        `).join('');

        // Guardar en variable global para usar en marcar pagado
        window.semanaActual = semanaCodigo;
      }

      // Marcar semana como pagada
      document.getElementById("btn-marcar-pagado")?.addEventListener("click", async () => {
        const semanaCodigo = window.semanaActual;
        
        if (!semanaCodigo) {
          mostrarError("‚ùå No hay semana seleccionada");
          return;
        }

        if (!confirm(`‚ö†Ô∏è ¬øMarcar la semana ${semanaCodigo} como PAGADA para TODAS LAS OPERARIAS?\n\n¬°ATENCI√ìN! Esto marcar√° como pagados TODOS los registros pendientes de TODAS las operarias en esta semana.\n\nSi solo quieres pagar a una operaria espec√≠fica, usa el bot√≥n "Marcar Pagada" de cada operaria.\n\n¬øContinuar?`)) {
          return;
        }

        try {
          const res = await fetch("/api/pagos/marcar-semana", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ semanaCodigo })
          });

          const data = await res.json();

          if (!res.ok) throw new Error(data.error || "Error al marcar como pagada");

          mostrarExito(`‚úÖ Semana marcada como pagada. ${data.registrosActualizados} registros actualizados. Total: $${data.totalPagado.toFixed(2)}`);

          // Recargar
          setTimeout(() => {
            cargarSemanas();
            listaResultados.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Selecciona una semana para consultar</p>';
            accionesGlobales.classList.add("oculto");
            totalGeneralContainer.classList.add("oculto");
          }, 2000);

        } catch (err) {
          mostrarError("‚ùå " + err.message);
        }
      });

      // Marcar operaria individual como pagada
      window.marcarOperariaPagada = async function(operariaId, operariaNombre, semanaCodigo, total) {
        if (!confirm(`¬øMarcar como PAGADA a ${operariaNombre}?\n\nSemana: ${semanaCodigo}\nTotal a pagar: $${total.toFixed(2)}\n\nEsto marcar√° todos sus registros pendientes de esta semana.`)) {
          return;
        }

        try {
          const res = await fetch("/api/pagos/marcar-semana", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              semanaCodigo,
              operariaId  // ‚Üê ESTO HACE QUE MARQUE SOLO A ESTA OPERARIA
            })
          });

          const data = await res.json();

          if (!res.ok) throw new Error(data.error || "Error al marcar como pagada");

          mostrarExito(`‚úÖ ${operariaNombre} marcada como pagada. ${data.registrosActualizados} registros actualizados. Total: $${data.totalPagado.toFixed(2)}`);

          // Recargar la consulta actual
          setTimeout(async () => {
            await cargarSemanas();
            await consultarPorSemana(); // Recarga la lista actual
          }, 1500);

        } catch (err) {
          mostrarError("‚ùå " + err.message);
        }
      };

      // Imprimir recibo individual
      window.imprimirRecibo = async function(operariaId, semanaCodigo) {
        try {
          const estado = selectEstadoPago.value;
          const res = await fetch(`/api/reporte-semanal/detalle?semana=${semanaCodigo}&operariaId=${operariaId}&estadoPago=${estado}`);
          
          if (!res.ok) throw new Error("Error al obtener detalle");
          
          const data = await res.json();
          
          const html = generarHTMLRecibo(data);
          
          const ventana = window.open('', '', 'width=800,height=600');
          ventana.document.write(html);
          ventana.document.close();
          
          ventana.onload = function() {
            ventana.focus();
            ventana.print();
          };

        } catch (err) {
          mostrarError("Error al generar recibo: " + err.message);
        }
      };

      // Ver detalle de registros por operaria
      window.verDetalleRegistros = async function(operariaId, operariaNombre, semanaCodigo) {
        try {
          // Validar par√°metros
          if (!semanaCodigo) {
            mostrarError("‚ùå Error: No se pudo obtener el c√≥digo de semana");
            console.error('semanaCodigo est√° vac√≠o:', semanaCodigo);
            return;
          }
          
          if (!operariaId) {
            mostrarError("‚ùå Error: No se pudo obtener el ID de operaria");
            console.error('operariaId est√° vac√≠o:', operariaId);
            return;
          }
          
          const estado = selectEstadoPago.value;
          const url = `/api/reporte-semanal/detalle?semana=${encodeURIComponent(semanaCodigo)}&operariaId=${operariaId}&estadoPago=${estado}`;
          
          console.log('üìã Llamando a Ver Detalle:', { semanaCodigo, operariaId, estado, url });
          
          const res = await fetch(url);
          
          if (!res.ok) {
            const errorData = await res.json().catch(() => ({ error: 'Error desconocido' }));
            throw new Error(errorData.error || `Error ${res.status}`);
          }
          
          const data = await res.json();
          
          // Actualizar t√≠tulo
          document.getElementById('modal-detalle-titulo').textContent = `üìã Detalle de Registros - ${operariaNombre}`;
          document.getElementById('modal-detalle-subtitulo').textContent = `${data.semana.label} | Total: $${data.resumen.totalPagar.toFixed(2)}`;
          
          // Generar contenido
          let html = '';
          
          if (data.registrosPorDia.length === 0) {
            html = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No hay registros para mostrar</p>';
          } else {
            data.registrosPorDia.forEach(dia => {
              html += `
                <div class="detalle-dia">
                  <div class="detalle-dia-titulo">${dia.dia} ${formatearFechaDetalle(dia.fecha)}</div>
                  ${dia.registros.map(reg => `
                    <div class="detalle-registro">
                      <div class="detalle-registro-header">
                        <div>
                          <div class="detalle-escuela">${reg.escuela} - ${reg.prenda}</div>
                          <div class="detalle-descripcion">"${reg.descripcion}"</div>
                        </div>
                      </div>
                      <div class="detalle-calculo">
                        <span class="detalle-cantidad">${reg.cantidad} piezas √ó $${(reg.pagoPorPieza || 0).toFixed(2)}</span>
                        <span class="detalle-total">$${(reg.totalGanado || 0).toFixed(2)}</span>
                      </div>
                    </div>
                  `).join('')}
                  <div class="detalle-subtotal">Subtotal d√≠a: $${(dia.subtotal || 0).toFixed(2)}</div>
                </div>
              `;
            });
            
            html += `
              <div class="detalle-total-general">
                <div class="detalle-total-general-label">TOTAL SEMANA</div>
                <div class="detalle-total-general-valor">$${data.resumen.totalPagar.toFixed(2)}</div>
                <div style="margin-top: 12px; color: var(--text-muted); font-size: 14px;">
                  ${data.resumen.totalPiezas} piezas | ${data.resumen.totalRegistros} registros | ${data.resumen.diasTrabajados} d√≠as
                </div>
              </div>
            `;
          }
          
          document.getElementById('modal-detalle-body').innerHTML = html;
          
          // Mostrar modal
          document.getElementById('modal-detalle').classList.add('show');
          
          // Guardar datos para imprimir
          window.detalleActual = data;
          
        } catch (err) {
          mostrarError("Error al cargar detalle: " + err.message);
        }
      };

      // Cerrar modal de detalle
      window.cerrarModalDetalle = function() {
        document.getElementById('modal-detalle').classList.remove('show');
      };

      // Imprimir modal de detalle
      window.imprimirModalDetalle = function() {
        if (!window.detalleActual) return;
        
        const html = generarHTMLDetalleCompleto(window.detalleActual);
        
        const ventana = window.open('', '', 'width=800,height=600');
        ventana.document.write(html);
        ventana.document.close();
        
        ventana.onload = function() {
          ventana.focus();
          ventana.print();
        };
      };

      // Cerrar modal al hacer click fuera
      document.getElementById('modal-detalle').addEventListener('click', function(e) {
        if (e.target === this) {
          cerrarModalDetalle();
        }
      });

      // Helper para formatear fecha en detalle
      function formatearFechaDetalle(fechaStr) {
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const fecha = new Date(fechaStr + 'T12:00:00');
        return `${fecha.getDate()} de ${meses[fecha.getMonth()]} ${fecha.getFullYear()}`;
      }

      // Generar HTML completo para imprimir detalle
      function generarHTMLDetalleCompleto(data) {
        let registrosHTML = '';
        
        // Columnas din√°micas para impresi√≥n (seg√∫n cantidad de registros)
        const totalRegistros = (data?.resumen?.totalRegistros != null)
          ? data.resumen.totalRegistros
          : (data?.registrosPorDia || []).reduce((acc, d) => acc + ((d.registros || []).length), 0);
        const columnasImpresion = totalRegistros > 10 ? 3 : (totalRegistros > 4 ? 2 : 1);
        const fontImpresion = columnasImpresion === 3 ? 9.5 : (columnasImpresion === 2 ? 10.5 : 11);
        
        data.registrosPorDia.forEach(dia => {
          registrosHTML += `
            <div class="dia-seccion" style="margin-bottom: 20px;">
              <div style="font-weight: 700; color: #2563eb; font-size: 16px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">
                ${dia.dia} ${formatearFechaDetalle(dia.fecha)}
              </div>
              ${dia.registros.map(reg => `
                <div class="registro-card" style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e5e7eb;">
                  <div style="font-weight: 600; margin-bottom: 4px;">${reg.escuela} - ${reg.prenda}</div>
                  <div class="registro-desc" style="color: #6b7280; font-style: italic; font-size: 14px; margin-bottom: 8px;">"${reg.descripcion}"</div>
                  <div class="registro-line" style="display: flex; justify-content: space-between; padding: 8px; background: rgba(37, 99, 235, 0.08); border-radius: 6px;">
                    <span style="color: #374151;">${reg.cantidad} piezas √ó $${(reg.pagoPorPieza || 0).toFixed(2)}</span>
                    <span style="font-weight: 600; color: #2563eb;">$${(reg.totalGanado || 0).toFixed(2)}</span>
                  </div>
                </div>
              `).join('')}
              <div style="text-align: right; font-weight: 600; padding: 8px; border-top: 2px solid #e5e7eb; margin-top: 8px;">
                Subtotal d√≠a: $${(dia.subtotal || 0).toFixed(2)}
              </div>
            </div>
          `;
        });
        
        return `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>Detalle de Registros - ${data.operaria.nombre}</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                max-width: 800px;
                margin: 20px auto;
                padding: 20px;
                color: #1f2937;
              }
              h1 {
                color: #2563eb;
                font-size: 24px;
                margin-bottom: 8px;
              }
              .subtitle {
                color: #6b7280;
                font-size: 14px;
                margin-bottom: 24px;
              }
              .total-general {
                background: rgba(37, 99, 235, 0.1);
                border: 2px solid #2563eb;
                padding: 20px;
                border-radius: 12px;
                text-align: center;
                margin-top: 24px;
              }
              .total-label {
                color: #6b7280;
                font-size: 14px;
                margin-bottom: 8px;
              }
              .total-valor {
                font-size: 36px;
                font-weight: 700;
                color: #2563eb;
              }
              .total-info {
                margin-top: 12px;
                color: #6b7280;
                font-size: 14px;
              }
                            @page {
                size: letter landscape;
                margin: 0.7cm;
              }
              @media print {
                body {
                  margin: 0;
                  padding: 10px;
                  max-width: none;
                  font-size: ${fontImpresion}px;
                }
                .registros-container {
                  column-count: ${columnasImpresion};
                  column-gap: 16px;
                  column-fill: auto;
                }
                .dia-seccion {
                  break-inside: avoid;
                  page-break-inside: avoid;
                }
              
                /* Compactar para que quepa en menos hojas */
                h1 { font-size: 16px !important; margin: 0 0 6px 0 !important; }
                .subtitle { font-size: 11px !important; margin: 0 0 10px 0 !important; }
                .dia-seccion > div:first-child { font-size: 12px !important; margin-bottom: 8px !important; }
                .registro-card { padding: 6px !important; margin-bottom: 6px !important; border-radius: 6px !important; }
                .registro-card > div:first-child { font-size: 11px !important; margin-bottom: 3px !important; }
                .registro-desc { font-size: 10.5px !important; margin-bottom: 5px !important; }
                .registro-line { padding: 5px !important; }
                .total-general { padding: 10px !important; margin-top: 10px !important; }
                .total-label { font-size: 11px !important; }
                .total-valor { font-size: 18px !important; }
}
            </style>
          </head>
          <body>
            <h1>üìã Detalle de Registros - ${data.operaria.nombre}</h1>
            <div class="subtitle">${data.semana.label}</div>
            
            <div class="registros-container">${registrosHTML}</div>
            
            <div class="total-general">
              <div class="total-label">TOTAL SEMANA</div>
              <div class="total-valor">$${data.resumen.totalPagar.toFixed(2)}</div>
              <div class="total-info">
                ${data.resumen.totalPiezas} piezas | ${data.resumen.totalRegistros} registros | ${data.resumen.diasTrabajados} d√≠as trabajados
              </div>
            </div>
          </body>
          </html>
        `;
      }

      // Imprimir todos los recibos
      document.getElementById("btn-imprimir-todos")?.addEventListener("click", async () => {
        const semanaCodigo = window.semanaActual;
        
        if (!semanaCodigo) {
          mostrarError("‚ùå No hay semana seleccionada");
          return;
        }

        try {
          const estado = selectEstadoPago.value;
          const res = await fetch(`/api/reporte-semanal?semana=${semanaCodigo}&estado=${estado}`);
          
          if (!res.ok) throw new Error("Error al consultar");
          
          const operarias = await res.json();
          
          if (operarias.length === 0) {
            mostrarError("No hay operarias con producci√≥n en esta semana");
            return;
          }

          if (!confirm(`¬øImprimir ${operarias.length} recibos?`)) {
            return;
          }

          let htmlCompleto = `
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="UTF-8">
              <title>Recibos Semana ${semanaCodigo}</title>
              <style>
                ${getEstilosRecibo()}
                @media print {
                  .recibo {
                    page-break-after: always;
                  }
                  .recibo:last-child {
                    page-break-after: auto;
                  }
                }
              </style>
            </head>
            <body>
          `;

          for (const op of operarias) {
            const resDetalle = await fetch(`/api/reporte-semanal/detalle?semana=${semanaCodigo}&operariaId=${op.operariaId}&estadoPago=${estado}`);
            const detalle = await resDetalle.json();
            htmlCompleto += generarReciboHTML(detalle);
          }

          htmlCompleto += '</body></html>';

          const ventana = window.open('', '', 'width=800,height=600');
          ventana.document.write(htmlCompleto);
          ventana.document.close();
          ventana.onload = function() {
            ventana.focus();
            ventana.print();
          };

        } catch (err) {
          mostrarError("Error al generar recibos: " + err.message);
        }
      });

      // Generar HTML completo del recibo
      function generarHTMLRecibo(data) {
        return `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>Recibo - ${data.operaria.nombre}</title>
            <style>
              ${getEstilosRecibo()}
            </style>
          </head>
          <body>
            ${generarReciboHTML(data)}
          </body>
          </html>
        `;
      }

      // Estilos para impresi√≥n
      function getEstilosRecibo() {
        return `
          body {
            font-family: 'Courier New', monospace;
            margin: 1.5cm;
            font-size: 11pt;
            color: #000;
          }
          .recibo {
            border: 2px solid #000;
            padding: 20px;
            max-width: 18cm;
            margin: 0 auto;
          }
          .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
          }
          .titulo {
            font-size: 18pt;
            font-weight: bold;
          }
          .subtitulo {
            font-size: 12pt;
          }
          .info-section {
            margin: 15px 0;
            line-height: 1.6;
          }
          .detalle-titulo {
            font-weight: bold;
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
            margin: 15px 0 10px 0;
          }
          .detalle-dia {
            margin: 10px 0;
          }
          .dia-titulo {
            font-weight: bold;
            margin-bottom: 5px;
          }
          .registro-item {
            margin-left: 20px;
            font-size: 10pt;
            line-height: 1.4;
            margin-bottom: 3px;
          }
          .subtotal-dia {
            text-align: right;
            font-size: 10pt;
            margin: 5px 20px 5px 0;
            font-weight: bold;
          }
          .totales {
            margin-top: 20px;
            border-top: 2px solid #000;
            padding-top: 10px;
            line-height: 1.8;
          }
          .total-final {
            font-size: 16pt;
            font-weight: bold;
            text-align: right;
            margin: 20px 0;
            padding: 10px;
            border: 2px solid #000;
          }
          .firma {
            margin-top: 40px;
            display: flex;
            justify-content: space-around;
          }
          .firma-linea {
            border-top: 1px solid #000;
            width: 180px;
            margin-top: 40px;
            text-align: center;
            padding-top: 5px;
            font-size: 9pt;
          }
          .footer {
            text-align: center;
            margin-top: 30px;
            font-size: 8pt;
            color: #666;
            border-top: 1px solid #ccc;
            padding-top: 10px;
          }
          .detalle-produccion {
            /* En pantalla se queda como lista normal */
          }

          @media print {
            body {
              margin: 1.2cm;
              /* Font size din√°mico por variable (pt) */
              font-size: var(--recibo-fs, 11pt);
            }
            .recibo {
              max-width: none;
              margin: 0;
            }
            .detalle-produccion {
              column-count: var(--recibo-cols, 1);
              column-gap: 14px;
            }
            .detalle-dia, .registro-item {
              break-inside: avoid;
              page-break-inside: avoid;
            }
          }

        `;
      }

      // Generar HTML del recibo
      function generarReciboHTML(data) {
        const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        const totalRegistrosRecibo = (data?.resumen?.totalRegistros != null)
          ? data.resumen.totalRegistros
          : (data?.registrosPorDia || []).reduce((acc, d) => acc + ((d.registros || []).length), 0);
        const reciboCols = totalRegistrosRecibo > 80 ? 3 : (totalRegistrosRecibo > 35 ? 2 : 1);
        const reciboFs = reciboCols === 3 ? '10pt' : (reciboCols === 2 ? '10.5pt' : '11pt');

        
        return `
          <div class="recibo" style="--recibo-cols:${reciboCols}; --recibo-fs:${reciboFs};">
            <div class="header">
              <div class="titulo">UNIFORMES BONAPARTE</div>
              <div class="subtitulo">Recibo de Pago Semanal</div>
            </div>
            
            <div class="info-section">
              <strong>Operaria:</strong> ${data.operaria.nombre}<br>
              <strong>Semana:</strong> ${data.semana.label}<br>
              <strong>Fecha de Pago:</strong> ${formatearFechaLarga(data.fechaPago)}
            </div>
            
            <div class="detalle-titulo">DETALLE DE PRODUCCI√ìN</div>
            
            <div class="detalle-produccion">
            ${data.registrosPorDia.map(dia => {
              const fecha = new Date(dia.fecha + 'T12:00:00');
              return `
                <div class="detalle-dia">
                  <div class="dia-titulo">${dia.dia} ${fecha.getDate()} ${obtenerMesCorto(fecha.getMonth())}</div>
                  ${dia.registros.map(r => `
                    <div class="registro-item">
                      ${r.escuela} - ${r.prenda}<br>
                      ${r.descripcion} | ${r.cantidad} pzs √ó $${r.precio.toFixed(2)} = $${r.total.toFixed(2)}
                    </div>
                  `).join('')}
                  <div class="subtotal-dia">Subtotal: $${dia.subtotal.toFixed(2)}</div>
                </div>
              `;
            }).join('')}
            </div>
            
            <div class="totales">
              <strong>RESUMEN</strong><br>
              Total de Piezas: ${data.resumen.totalPiezas}<br>
              Total de Registros: ${data.resumen.totalRegistros}<br>
              D√≠as Trabajados: ${data.resumen.diasTrabajados}
            </div>
            
            <div class="total-final">
              TOTAL A PAGAR: $${data.resumen.totalPagar.toFixed(2)}
            </div>
            
            <div class="firma">
              <div>
                <div class="firma-linea">Firma de la Operaria</div>
              </div>
              <div>
                <div class="firma-linea">Fecha</div>
              </div>
            </div>
            
            <div class="footer">
              Sistema Bonaparte V5 | Generado: ${new Date().toLocaleString('es-MX')}
            </div>
          </div>
        `;
      }

      // Funciones helper
      function formatearFecha(fechaStr) {
        const fecha = new Date(fechaStr + 'T12:00:00');
        return fecha.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }

      function formatearFechaLarga(fechaStr) {
        const fecha = new Date(fechaStr + 'T12:00:00');
        return fecha.toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' });
      }

      function obtenerMesCorto(mes) {
        const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        return meses[mes];
      }

      function mostrarError(mensaje) {
        mensajeError.textContent = mensaje;
        mensajeError.style.display = "block";
        mensajeExito.style.display = "none";
        setTimeout(() => { mensajeError.style.display = "none"; }, 5000);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function mostrarExito(mensaje) {
        mensajeExito.textContent = mensaje;
        mensajeExito.style.display = "block";
        mensajeError.style.display = "none";
        setTimeout(() => { mensajeExito.style.display = "none"; }, 5000);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      document.getElementById("btn-volver").addEventListener("click", () => {
        window.location.href = "/dashboard";
      });

      // Cargar semanas al iniciar
      cargarSemanas();

      // Cambiar semanas cuando cambia estado
      selectEstadoPago.addEventListener("change", cargarSemanas);
    });
  </script>

  <!-- Modal de Detalle de Registros -->
  <div class="modal-overlay" id="modal-detalle">
    <div class="modal-detalle">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="modal-detalle-titulo">Detalle de Registros</div>
          <div class="modal-subtitle" id="modal-detalle-subtitulo"></div>
        </div>
        <button class="modal-close" onclick="cerrarModalDetalle()">‚úï</button>
      </div>
      <div class="modal-body" id="modal-detalle-body">
        <!-- Contenido din√°mico -->
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="imprimirModalDetalle()">üñ®Ô∏è Imprimir</button>
        <button class="btn-primary" onclick="cerrarModalDetalle()">Cerrar</button>
      </div>
    </div>
  </div>
</body>
</html>
