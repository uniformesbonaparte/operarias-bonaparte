<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üì¶ Pedidos ¬∑ Uniformes Bonaparte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="icon" type="image/png" sizes="32x32" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0E0F12">

  <style>
    :root {
      --bg-dark: #0a0e27;
      --bg-darker: #050811;
      --glass: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    body { background: linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 100%); color: var(--text-main); min-height: 100vh; position: relative; overflow-x: hidden; }
    body::before, body::after { content: ''; position: fixed; border-radius: 50%; pointer-events: none; z-index: 0; }
    body::before { width: 500px; height: 500px; background: radial-gradient(circle, rgba(59,130,246,0.15) 0%, transparent 70%); top: -250px; right: -250px; animation: float 8s ease-in-out infinite; }
    body::after { width: 400px; height: 400px; background: radial-gradient(circle, rgba(245,158,11,0.15) 0%, transparent 70%); bottom: -200px; left: -200px; animation: float 10s ease-in-out infinite reverse; }
    @keyframes float { 0%,100%{transform:translateY(0) rotate(0deg);} 50%{transform:translateY(-20px) rotate(5deg);} }
    .shell { width: 100%; max-width: 600px; margin: 0 auto; padding: 24px; position: relative; z-index: 1; }
    header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 16px 20px; background: var(--glass); border-radius: 20px; border: 1px solid var(--glass-border); backdrop-filter: blur(20px); }
    .header-info h1 { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header-info span { font-size: 12px; color: var(--text-muted); }
    .btn-back { width: 40px; height: 40px; border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); color: var(--text-main); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; font-size: 20px; }
    .btn-back:hover { background: rgba(255,255,255,0.1); }
    .card { background: var(--glass); border-radius: 20px; border: 1px solid var(--glass-border); padding: 20px; margin-bottom: 16px; backdrop-filter: blur(20px); }
    .card-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
    .subtext { font-size: 12px; color: var(--text-muted); margin-bottom: 16px; }
    .form-row { margin-bottom: 12px; }
    .form-row label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: var(--text-main); font-size: 14px; outline: none; transition: border 0.3s; }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); }
    button { padding: 12px 20px; border: none; border-radius: 12px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: linear-gradient(135deg, var(--accent), #6366f1); color: white; width: 100%; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: var(--text-main); border: 1px solid rgba(255,255,255,0.1); }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }
    .btn-secondary.active { background: var(--accent); border-color: var(--accent); }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: var(--warning); color: #000; }
    .btn-edit { background: rgba(139,92,246,0.2); color: #a78bfa; border: 1px solid rgba(139,92,246,0.3); }
    .oculto { display: none !important; }
    .mensaje-error, .mensaje-exito { display: none; padding: 12px; border-radius: 12px; margin-bottom: 12px; font-size: 13px; font-weight: 600; text-align: center; }
    .mensaje-error { background: rgba(239,68,68,0.2); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
    .mensaje-exito { background: rgba(16,185,129,0.2); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.3); }
    .pedido-item { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 16px; margin-bottom: 12px; }
    .pedido-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .pedido-escuela { font-weight: 700; font-size: 15px; }
    .pedido-folio { font-size: 12px; color: var(--text-muted); }
    .badge { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; }
    .badge-proceso { background: rgba(59,130,246,0.2); color: #93c5fd; }
    .badge-terminado { background: rgba(16,185,129,0.2); color: #6ee7b7; }
    .pedido-info { font-size: 13px; color: var(--text-muted); margin-bottom: 6px; }
    .pedido-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .pedido-actions button { flex: 1; min-width: 80px; padding: 8px; font-size: 12px; }
    .filtros-row { display: flex; gap: 12px; margin-bottom: 16px; }
    .filtros-row button { flex: 1; }
    .prendas-lista { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .prenda-tag { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; background: rgba(59,130,246,0.2); color: #93c5fd; }

    /* Items (nuevo) */
    .item-card { background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 14px; margin-bottom: 10px; }
    .item-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 10px; }
    .item-header-left { display: flex; gap: 8px; align-items: center; flex: 1; }
    .item-header-left select { flex: 1; }
    .item-header-left input[type="number"] { width: 80px; }
    .btn-remove-item { background: rgba(239,68,68,0.2); color: #fca5a5; border: 1px solid rgba(239,68,68,0.2); width: 32px; height: 32px; border-radius: 8px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; min-width: 32px; }
    .ops-table { width: 100%; font-size: 12px; border-collapse: collapse; margin-top: 8px; }
    .ops-table th { text-align: left; color: var(--text-muted); font-weight: 600; font-size: 10px; text-transform: uppercase; padding: 6px 4px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .ops-table td { padding: 5px 4px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-main); }
    .ops-table input[type="number"] { width: 65px; padding: 6px; font-size: 12px; border-radius: 8px; }
    .ops-table .op-costura-input { width: 100%; padding: 6px 8px; font-size: 12px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); }
    .ops-table .op-maquina-select { width: 100px; padding: 6px; font-size: 11px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); }
    .ops-table .btn-remove-op { background: none; border: none; color: #fca5a5; cursor: pointer; font-size: 14px; padding: 2px 6px; }
    .btn-add-op { background: rgba(59,130,246,0.15); color: #93c5fd; border: 1px dashed rgba(59,130,246,0.3); font-size: 11px; padding: 6px 12px; margin-top: 6px; border-radius: 8px; }
    .btn-add-item { background: rgba(16,185,129,0.15); color: #6ee7b7; border: 1px dashed rgba(16,185,129,0.3); width: 100%; padding: 12px; margin-bottom: 14px; font-size: 13px; }
    .progress-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 6px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--accent), var(--success)); transition: width 0.3s; }
    .items-resumen { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
    .items-resumen-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 12px; }
    .items-resumen-item .prenda-name { color: var(--text-main); font-weight: 600; }
    .items-resumen-item .cant { color: var(--text-muted); }
    .desglose-prendas { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); }
    .desglose-titulo { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
    .desglose-item { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; }
    .desglose-prenda { color: var(--text-muted); }
    .desglose-monto { color: var(--success); font-weight: 600; }

    /* Modales */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal.active { display: flex; }
    .modal-content { background: linear-gradient(135deg, #0d1230, #0a0e27); backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid var(--glass-border); padding: 24px; max-width: 550px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--glass-border); }
    .modal-title { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, #8b5cf6, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .modal-close { width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); color: var(--text-main); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; font-size: 20px; }
    .modal-close:hover { background: rgba(255,255,255,0.1); transform: rotate(90deg); }
    .modal-actions { display: flex; gap: 12px; margin-top: 20px; }
    .modal-actions button { flex: 1; }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <button class="btn-back" id="btn-volver">‚Üê</button>
      <div class="header-info">
        <h1>üì¶ Pedidos</h1>
        <span>Usuario: <strong id="nombre-usuario"></strong></span>
      </div>
    </header>
    <main>
      <div class="mensaje-error" id="mensaje-error"></div>
      <div class="mensaje-exito" id="mensaje-exito"></div>

      <!-- Formulario nuevo pedido -->
      <section class="card oculto" id="card-nuevo-pedido">
        <div class="card-title">‚ûï Nuevo Pedido</div>
        <p class="subtext">Registra un pedido con prendas, cantidades y costuras</p>
        <div class="form-row">
          <label for="input-escuela">üè´ Escuela</label>
          <input type="text" id="input-escuela" placeholder="Nombre de la escuela" />
        </div>
        <div class="form-row">
          <label for="input-folio">üìÑ Folio</label>
          <input type="text" id="input-folio" placeholder="Folio del pedido" />
        </div>
        <div class="form-row">
          <label>üß• Prendas del Pedido</label>
          <button class="btn-add-item" id="btn-agregar-item">‚ûï Agregar Prenda</button>
          <div id="items-nuevo-pedido"></div>
        </div>
        <button class="btn-primary" id="btn-guardar-pedido">üíæ Guardar Pedido</button>
      </section>

      <!-- Filtros -->
      <section class="card oculto" id="card-filtros">
        <div class="card-title">üîç Filtros</div>
        <div class="filtros-row">
          <button class="btn-secondary active" id="filtro-proceso">En Proceso</button>
          <button class="btn-secondary" id="filtro-terminado">Terminados</button>
          <button class="btn-secondary" id="filtro-todos">Todos</button>
        </div>
      </section>

      <!-- Lista -->
      <section class="card">
        <div class="card-title">üìã Lista de Pedidos</div>
        <p class="subtext" id="subtext-lista">Pedidos registrados</p>
        <div id="lista-pedidos"></div>
      </section>
    </main>

    <!-- Modal Editar -->
    <div id="modal-editar" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">‚úèÔ∏è Editar Pedido</div>
          <div class="modal-close" id="modal-close">√ó</div>
        </div>
        <div class="form-row">
          <label for="edit-escuela">üè´ Escuela</label>
          <input type="text" id="edit-escuela" />
        </div>
        <div class="form-row">
          <label for="edit-folio">üìã Folio</label>
          <input type="text" id="edit-folio" />
        </div>
        <div class="form-row">
          <label>üß• Prendas</label>
          <button class="btn-add-item" id="btn-agregar-item-edit">‚ûï Agregar Prenda</button>
          <div id="items-edit-pedido"></div>
        </div>
        <div class="modal-actions">
          <button class="btn-danger" id="btn-cancelar-editar">‚ùå Cancelar</button>
          <button class="btn-primary" id="btn-guardar-editar">üíæ Guardar Cambios</button>
        </div>
      </div>
    </div>

    <!-- Modal Avance -->
    <div id="modal-avance" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">üìä Avance del Pedido</div>
          <div class="modal-close" id="modal-avance-close">√ó</div>
        </div>
        <div id="avance-contenido"></div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      let usuarioActual;
      try {
        const d = localStorage.getItem("usuarioActual");
        if (!d) throw new Error();
        usuarioActual = JSON.parse(d);
        if (!usuarioActual.tipo || !usuarioActual.nombre) throw new Error();
      } catch { localStorage.removeItem("usuarioActual"); alert("Sesi√≥n inv√°lida."); window.location.href="/login.html"; return; }

      const spanNombre = document.getElementById("nombre-usuario");
      const cardNuevo = document.getElementById("card-nuevo-pedido");
      const cardFiltros = document.getElementById("card-filtros");
      const listaPedidos = document.getElementById("lista-pedidos");
      const msgErr = document.getElementById("mensaje-error");
      const msgOk = document.getElementById("mensaje-exito");
      const modalEditar = document.getElementById("modal-editar");
      const modalAvance = document.getElementById("modal-avance");

      let filtroActual = "activo";
      let pedidoEditando = null;
      const esEnc = usuarioActual.tipo === "encargada";
      const esAdmin = usuarioActual.tipo === "admin";
      if (spanNombre) spanNombre.textContent = usuarioActual.nombre;

      let prendasCache = [];
      let maquinasCache = [];

      async function cargarDatosBase() {
        try {
          const [rp, rm] = await Promise.all([fetch("/api/prendas"), fetch("/api/maquinas")]);
          prendasCache = await rp.json();
          maquinasCache = await rm.json();
        } catch(e) { console.error("Error cargando datos base:", e); }
      }
      await cargarDatosBase();

      if (esAdmin || esEnc) { cardNuevo.classList.remove("oculto"); cardFiltros.classList.remove("oculto"); }
      if (usuarioActual.tipo === "operaria") filtroActual = "activo";

      // ========== ITEMS SYSTEM ==========
      function crearItemHTML(containerId, itemData) {
        const container = document.getElementById(containerId);
        const div = document.createElement("div");
        div.className = "item-card";
        const opts = prendasCache.map(p =>
          `<option value="${p.id}" ${itemData && itemData.prendaId === p.id ? 'selected' : ''}>${p.nombre}</option>`
        ).join("");
        div.innerHTML = `
          <div class="item-header">
            <div class="item-header-left">
              <select class="sel-prenda" onchange="window._cargarPlantilla(this)">\n                <option value="">-- Prenda --</option>${opts}
              </select>
              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;"><div class="badge" style="padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.18);font-size:12px;">Total: <span class="lbl-total-cantidad">${itemData ? (itemData.cantidad || 0) : 0}</span> pzs</div><button type="button" class="btn-secondary" style="padding:6px 10px;font-size:12px;" onclick="window._addTalla(this)">+ Talla</button></div>
            </div>
            <button class="btn-remove-item" onclick="this.closest('.item-card').remove()">‚úï</button>
          </div>
          <div class="tallas-container" style="margin-top:10px;"></div>
          <div class="ops-container" style="margin-top:10px;"></div>`;
        container.appendChild(div);
        // Render tallas
        renderTallas(div, (itemData && itemData.tallas) ? itemData.tallas : []);
        if (itemData && itemData.operaciones && itemData.operaciones.length > 0) {
          renderOps(div, itemData.operaciones);
        } else if (itemData && itemData.prendaId) {
          cargarPlantilla(div, itemData.prendaId);
        }
      }

      window._cargarPlantilla = function(sel) {
        const card = sel.closest(".item-card");
        if (!sel.value) { card.querySelector(".ops-container").innerHTML = ""; return; }
        cargarPlantilla(card, sel.value);
      };

      
      function renderTallas(card, tallas) {
        const c = card.querySelector(".tallas-container");
        let h = `<table class="ops-table"><thead><tr><th>Talla</th><th>Cant.</th><th></th></tr></thead><tbody>`;
        (tallas || []).forEach(t => {
          h += `<tr>
            <td><input type="text" class="talla-input" value="${(t.talla||'')}" placeholder="Ej: 10 / CH / 28" /></td>
            <td><input type="number" class="talla-cantidad" value="${Number(t.cantidad)||0}" min="0" step="1" /></td>
            <td><button class="btn-remove-op" onclick="this.closest('tr').remove(); window._recalcularTotal(this);">‚úï</button></td>
          </tr>`;
        });
        h += `</tbody></table>`;
        c.innerHTML = h;
        // Recalcular total al render
        recalcularTotal(card);
        // Listener de cambio
        c.querySelectorAll(".talla-input,.talla-cantidad").forEach(inp => {
          inp.addEventListener("input", () => recalcularTotal(card));
        });
      }

      function recalcularTotal(card) {
        let total = 0;
        card.querySelectorAll(".tallas-container tbody tr").forEach(tr => {
          const cant = Number(tr.querySelector(".talla-cantidad").value) || 0;
          total += cant;
        });
        const lbl = card.querySelector(".lbl-total-cantidad");
        if (lbl) lbl.textContent = total;
      }

      window._recalcularTotal = function(el) {
        const card = el.closest(".item-card");
        recalcularTotal(card);
      };

      window._addTalla = function(btn) {
        const card = btn.closest(".item-card");
        const tbody = card.querySelector(".tallas-container tbody");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="text" class="talla-input" placeholder="Ej: 10 / CH / 28" /></td>
          <td><input type="number" class="talla-cantidad" value="0" min="0" step="1" /></td>
          <td><button class="btn-remove-op" onclick="this.closest('tr').remove(); window._recalcularTotal(this);">‚úï</button></td>`;
        tbody.appendChild(tr);
        tr.querySelectorAll(".talla-input,.talla-cantidad").forEach(inp => {
          inp.addEventListener("input", () => recalcularTotal(card));
        });
        recalcularTotal(card);
      };

async function cargarPlantilla(card, prendaId) {
        try {
          const r = await fetch(`/api/plantillas-costuras/${prendaId}`);
          const d = await r.json();
          renderOps(card, (d.operaciones||[]).map(o => ({costura:o.costura, maquina:o.maquina, precio:0})));
        } catch(e) { console.error(e); }
      }

      function renderOps(card, ops) {
        const c = card.querySelector(".ops-container");
        const mOpts = maquinasCache.map(m => `<option value="${m}">${m}</option>`).join("");
        let h = `<table class="ops-table"><thead><tr><th>Costura</th><th>M√°quina</th><th>$</th><th></th></tr></thead><tbody>`;
        ops.forEach(op => {
          const sel = maquinasCache.map(m => `<option value="${m}" ${m===op.maquina?'selected':''}>${m}</option>`).join("");
          h += `<tr>
            <td><input type="text" class="op-costura-input" value="${op.costura||op.descripcion||''}" readonly style="opacity:0.9;" /></td>
            <td><input type="text" class="op-maquina-select" value="${op.maquina||''}" readonly style="opacity:0.9;" /></td>
            <td><input type="number" class="op-precio" value="${op.precio||0}" min="0" step="0.5" /></td>
            <td style="color:rgba(255,255,255,0.35);font-size:12px;">cat√°logo</td>
          </tr>`;
        });
        h += `</tbody></table><div style="margin-top:6px;color:rgba(255,255,255,0.55);font-size:12px;">Operaciones cargadas del cat√°logo (no se pueden editar).</div>`;
        c.innerHTML = h;
      }

      /* Operaciones vienen del cat√°logo: ya no se permite agregar/eliminar desde aqu√≠ */

      function extraerItems(containerId) {
        const items = [];
        document.getElementById(containerId).querySelectorAll(".item-card").forEach(card => {
          const prendaId = Number(card.querySelector(".sel-prenda").value);
          const tallas = [];
          card.querySelectorAll(".tallas-container tbody tr").forEach(tr => {
            const talla = tr.querySelector(".talla-input").value.trim();
            const c = Number(tr.querySelector(".talla-cantidad").value) || 0;
            if (talla && c > 0) tallas.push({ talla, cantidad: c });
          });
          const cantidad = tallas.length > 0 ? tallas.reduce((s,t)=>s+t.cantidad,0) : 0;
          if (!prendaId || !cantidad) return;
          const operaciones = [];
          card.querySelectorAll(".ops-container .ops-table tbody tr").forEach(tr => {
            const costura = tr.querySelector(".op-costura-input").value.trim();
            const maquina = tr.querySelector(".op-maquina-select").value;
            const precio = Number(tr.querySelector(".op-precio").value) || 0;
            if (costura && maquina) operaciones.push({costura, maquina, precio});
          });
          items.push({prendaId, cantidad, tallas, operaciones});
        });
        return items;
      }

      document.getElementById("btn-agregar-item").addEventListener("click", () => crearItemHTML("items-nuevo-pedido"));
      document.getElementById("btn-agregar-item-edit").addEventListener("click", () => crearItemHTML("items-edit-pedido"));

      // ========== GUARDAR NUEVO ==========
      document.getElementById("btn-guardar-pedido").addEventListener("click", async () => {
        const escuela = document.getElementById("input-escuela").value.trim();
        const folio = document.getElementById("input-folio").value.trim();
        const items = extraerItems("items-nuevo-pedido");
        if (!escuela || !folio) { mostrarError("‚ùå Completa escuela y folio"); return; }
        if (items.length === 0) { mostrarError("‚ùå Agrega al menos una prenda con cantidad"); return; }

        const btn = document.getElementById("btn-guardar-pedido");
        btn.disabled = true; btn.textContent = "‚è≥ Guardando...";
        try {
          const res = await fetch("/api/pedidos", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({escuela, folio, items}) });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error);
          mostrarExito("‚úÖ Pedido creado");
          document.getElementById("input-escuela").value = "";
          document.getElementById("input-folio").value = "";
          document.getElementById("items-nuevo-pedido").innerHTML = "";
          await cargarPedidos();
        } catch(e) { mostrarError("‚ùå " + e.message); }
        finally { btn.disabled = false; btn.textContent = "üíæ Guardar Pedido"; }
      });

      // ========== FILTROS ==========
      document.getElementById("filtro-proceso").addEventListener("click", () => cambiarFiltro("activo","filtro-proceso"));
      document.getElementById("filtro-terminado").addEventListener("click", () => cambiarFiltro("terminado","filtro-terminado"));
      document.getElementById("filtro-todos").addEventListener("click", () => cambiarFiltro("todos","filtro-todos"));
      function cambiarFiltro(f, id) {
        filtroActual = f;
        document.querySelectorAll(".filtros-row button").forEach(b => b.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        cargarPedidos();
      }

      // ========== LISTA PEDIDOS ==========
      async function cargarPedidos() {
        try {
          let url = `/api/pedidos?conTotales=true&conPrendas=true&conDesglose=true`;
          url += usuarioActual.tipo === "operaria" ? `&estado=activo` : `&estado=${filtroActual}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error("Error");
          const pedidos = await res.json();
          if (pedidos.length === 0) { listaPedidos.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:20px;">No hay pedidos</p>'; return; }

          listaPedidos.innerHTML = pedidos.map(p => {
            let desglose = '';
            if (!esEnc && p.desglosePrendas && p.desglosePrendas.length > 0) {
              desglose = `<div class="desglose-prendas"><div class="desglose-titulo">üí∞ Desglose:</div>
                ${p.desglosePrendas.map(d => `<div class="desglose-item"><span class="desglose-prenda">${d.prenda}</span><span class="desglose-monto">$${d.total.toFixed(2)}</span></div>`).join('')}</div>`;
            }

            let itemsHTML = '';
            if (p.items && p.items.length > 0) {
              itemsHTML = `<div class="items-resumen"><div class="desglose-titulo">üìã Prendas:</div>
                ${p.items.map(it => {
                  const pr = prendasCache.find(x => x.id === it.prendaId);
                  const nm = pr ? pr.nombre : (it.prenda || "?");
                  return `<div class="items-resumen-item"><span class="prenda-name">${nm}</span><span class="cant">${it.cantidad} pzas ¬∑ ${(it.operaciones||[]).length} ops</span></div>`;
                }).join('')}</div>`;
            } else if (p.prendas && p.prendas.length > 0) {
              itemsHTML = `<div class="pedido-info"><strong>Prendas:</strong><div class="prendas-lista">${p.prendas.map(x => `<span class="prenda-tag">${x}</span>`).join('')}</div></div>`;
            }

            const costo = p.costoEstimado || 0;

            return `<div class="pedido-item">
              <div class="pedido-header">
                <div><div class="pedido-escuela">${p.escuela}</div><div class="pedido-folio">Folio: ${p.folio}</div></div>
                <span class="badge ${p.estado==='activo'?'badge-proceso':'badge-terminado'}">${p.estado==='activo'?'üîÑ En Proceso':'‚úÖ Terminado'}</span>
              </div>
              ${itemsHTML}
              <div class="pedido-info">üì¶ Piezas registradas: <strong>${p.totalPiezas||0}</strong></div>
              <div class="pedido-info">üë• Operarias: <strong>${p.numeroOperarias||0}</strong></div>
              ${!esEnc ? `<div class="pedido-info">üíµ Pagado: <strong>$${(p.totalPagado||0).toFixed(2)}</strong>${costo>0?` <span style="color:var(--text-muted);font-size:11px;">/ Est: $${costo.toFixed(2)}</span>`:''}</div>${desglose}` : ''}
              ${(esAdmin||esEnc) ? `<div class="pedido-actions">
                ${p.items&&p.items.length>0?`<button class="btn-edit" onclick="verAvance(${p.id})" style="background:rgba(59,130,246,0.2);color:#93c5fd;border:1px solid rgba(59,130,246,0.3);">üìä Avance</button>`:''}
                <button class="btn-edit" onclick="abrirModalEditar(${p.id})">‚úèÔ∏è Editar</button>
                ${p.estado==='activo'?`<button class="btn-warning" onclick="marcarTerminado(${p.id})">‚úÖ Terminado</button>`:`<button class="btn-success" onclick="marcarActivo(${p.id})">üîÑ Reactivar</button>`}
                ${esAdmin?`<button class="btn-danger" onclick="eliminarPedido(${p.id})">üóëÔ∏è</button>`:''}
              </div>` : ''}
            </div>`;
          }).join("");
        } catch(e) { mostrarError("Error cargando pedidos: " + e.message); }
      }

      // ========== ACCIONES ==========
      window.marcarTerminado = async function(id) {
        if (!confirm("¬øMarcar como terminado?")) return;
        try { const r = await fetch(`/api/pedidos/${id}/estado`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({estado:"terminado"})}); if(!r.ok) throw new Error(); mostrarExito("‚úÖ Terminado"); await cargarPedidos(); } catch(e){mostrarError("‚ùå Error");}
      };
      window.marcarActivo = async function(id) {
        if (!confirm("¬øReactivar?")) return;
        try { const r = await fetch(`/api/pedidos/${id}/estado`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({estado:"activo"})}); if(!r.ok) throw new Error(); mostrarExito("‚úÖ Reactivado"); await cargarPedidos(); } catch(e){mostrarError("‚ùå Error");}
      };
      window.eliminarPedido = async function(id) {
        if (!confirm("¬øEliminar? No se puede deshacer.")) return;
        try { const r = await fetch(`/api/pedidos/${id}`,{method:"DELETE"}); const d = await r.json(); if(!r.ok) throw new Error(d.error); mostrarExito("‚úÖ Eliminado"); await cargarPedidos(); } catch(e){mostrarError("‚ùå "+e.message);}
      };

      // ========== MODAL EDITAR ==========
      window.abrirModalEditar = async function(id) {
        try {
          const r = await fetch(`/api/pedidos/${id}`);
          if (!r.ok) throw new Error();
          pedidoEditando = await r.json();
          document.getElementById("edit-escuela").value = pedidoEditando.escuela;
          document.getElementById("edit-folio").value = pedidoEditando.folio;
          document.getElementById("items-edit-pedido").innerHTML = "";
          if (pedidoEditando.items && pedidoEditando.items.length > 0) {
            pedidoEditando.items.forEach(it => crearItemHTML("items-edit-pedido", it));
          } else if (pedidoEditando.prendas) {
            const pids = Array.isArray(pedidoEditando.prendas) ? pedidoEditando.prendas : [];
            pids.forEach(pid => crearItemHTML("items-edit-pedido", {prendaId:Number(pid), cantidad:0, operaciones:[]}));
          }
          modalEditar.classList.add("active");
        } catch(e) { mostrarError("‚ùå Error cargando pedido"); }
      };

      function cerrarModal() { modalEditar.classList.remove("active"); pedidoEditando = null; }
      document.getElementById("modal-close").addEventListener("click", cerrarModal);
      document.getElementById("btn-cancelar-editar").addEventListener("click", cerrarModal);
      modalEditar.addEventListener("click", e => { if(e.target===modalEditar) cerrarModal(); });

      document.getElementById("btn-guardar-editar").addEventListener("click", async () => {
        if (!pedidoEditando) return;
        const escuela = document.getElementById("edit-escuela").value.trim();
        const folio = document.getElementById("edit-folio").value.trim();
        const items = extraerItems("items-edit-pedido");
        if (!escuela || !folio) { mostrarError("‚ùå Completa los campos"); return; }

        const btn = document.getElementById("btn-guardar-editar");
        btn.disabled = true; btn.textContent = "‚è≥ Guardando...";
        try {
          const r = await fetch(`/api/pedidos/${pedidoEditando.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({escuela, folio, items})});
          const d = await r.json();
          if (!r.ok) throw new Error(d.error);
          mostrarExito("‚úÖ Actualizado");
          cerrarModal();
          await cargarPedidos();
        } catch(e) { mostrarError("‚ùå "+e.message); }
        finally { btn.disabled = false; btn.textContent = "üíæ Guardar Cambios"; }
      });

      // ========== MODAL AVANCE ==========
      window.verAvance = async function(id) {
        try {
          const r = await fetch(`/api/pedidos/${id}/avance`);
          if (!r.ok) throw new Error();
          const data = await r.json();
          let h = `<div style="margin-bottom:12px;"><strong>${data.escuela}</strong> ¬∑ Folio: ${data.folio}<br>
            <span style="font-size:12px;color:var(--text-muted);">Estimado: $${(data.costoEstimadoTotal||0).toFixed(2)} ¬∑ Avance: $${(data.costoAvanceTotal||0).toFixed(2)}</span></div>`;
          (data.avance||[]).forEach(item => {
            h += `<div class="item-card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <strong style="font-size:14px;">${item.prenda}</strong>
                <span style="font-size:12px;color:${item.porcentajeGeneral>=100?'var(--success)':'var(--accent)'};font-weight:700;">${item.porcentajeGeneral}%</span>
              </div>
              <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(item.porcentajeGeneral,100)}%"></div></div>
              <div style="font-size:11px;color:var(--text-muted);margin:6px 0;">${item.cantidad} pzas ¬∑ ${item.operacionesCompletas}/${item.totalOperaciones} ops completas</div>
              <table class="ops-table"><thead><tr><th>Operaci√≥n</th><th>M√°quina</th><th>Avance</th><th>%</th></tr></thead><tbody>
              ${item.operaciones.map(op => `<tr>
                <td>${op.costura}</td>
                <td style="font-size:11px;color:var(--text-muted);">${op.maquina}</td>
                <td>${op.piezasHechas}/${op.cantidadTotal}</td>
                <td style="color:${op.porcentaje>=100?'var(--success)':op.porcentaje>0?'var(--accent)':'var(--text-muted)'};font-weight:700;">${op.porcentaje}%</td>
              </tr>`).join("")}
              </tbody></table>
            </div>`;
          });
          document.getElementById("avance-contenido").innerHTML = h;
          modalAvance.classList.add("active");
        } catch(e) { mostrarError("‚ùå Error cargando avance"); }
      };
      document.getElementById("modal-avance-close").addEventListener("click", () => modalAvance.classList.remove("active"));
      modalAvance.addEventListener("click", e => { if(e.target===modalAvance) modalAvance.classList.remove("active"); });

      // ========== HELPERS ==========
      function mostrarError(m) { msgErr.textContent=m; msgErr.style.display="block"; msgOk.style.display="none"; setTimeout(()=>{msgErr.style.display="none";},5000); }
      function mostrarExito(m) { msgOk.textContent=m; msgOk.style.display="block"; msgErr.style.display="none"; setTimeout(()=>{msgOk.style.display="none";},3000); }
      document.getElementById("btn-volver").addEventListener("click", () => { window.location.href = "/dashboard"; });

      await cargarPedidos();
    });
  </script>
</body>
</html>
