<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üìù Producci√≥n ¬∑ Uniformes Bonaparte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="icon" type="image/png" sizes="32x32" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0E0F12">

  <style>
    :root {
      --bg-dark: #0a0e27;
      --bg-darker: #050811;
      --glass: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 100%);
      color: var(--text-main);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before, body::after {
      content: '';
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
    }

    body::before {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
      top: -250px;
      right: -250px;
      animation: float 8s ease-in-out infinite;
    }

    body::after {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(16, 185, 129, 0.15) 0%, transparent 70%);
      bottom: -200px;
      left: -200px;
      animation: float 10s ease-in-out infinite reverse;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
    }

    .shell {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 24px;
      position: relative;
      z-index: 1;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding: 16px 20px;
      border-radius: 20px;
      background: var(--glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .btn-back {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.3);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 20px;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(-2px);
    }

    .header-info {
      flex: 1;
    }

    .header-info h1 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 2px;
      background: linear-gradient(135deg, #10b981, #059669);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-info span {
      font-size: 13px;
      color: var(--text-muted);
    }

    main {
      padding-bottom: 40px;
    }

    .card {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid var(--glass-border);
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      margin-bottom: 16px;
      animation: fadeInUp 0.5s ease-out backwards;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subtext {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.3);
      color: var(--text-main);
      font-size: 15px;
      outline: none;
      transition: all 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--success);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      background: rgba(0, 0, 0, 0.4);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .btn-primary {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid var(--glass-border);
      background: rgba(59, 130, 246, 0.2);
      color: #93c5fd;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      background: rgba(59, 130, 246, 0.3);
    }

    .btn-secondary.active {
      background: rgba(59, 130, 246, 0.4);
      color: white;
    }

    .btn-danger {
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid var(--glass-border);
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    .costura-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 12px;
    }

    .costura-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .costura-operaria {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
    }

    .costura-fecha {
      font-size: 12px;
      color: var(--text-muted);
    }

    .costura-info {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .costura-info strong {
      color: var(--text-main);
    }

    .costura-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .precio-input {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 12px;
    }

    .precio-input input {
      flex: 1;
      margin: 0;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
    }

    .badge-warning {
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
    }

    .badge-operaria {
      background: rgba(59, 130, 246, 0.2);
      color: #93c5fd;
    }

    .badge-encargada {
      background: rgba(168, 85, 247, 0.2);
      color: #c084fc;
    }

    .mensaje-error, .mensaje-exito {
      padding: 12px 16px;
      border-radius: 14px;
      margin-bottom: 16px;
      display: none;
      font-size: 13px;
    }

    .mensaje-error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }

    .mensaje-exito {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #6ee7b7;
    }

    .oculto {
      display: none !important;
    }

    .filtros-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .filtros-row select {
      flex: 1;
      min-width: 150px;
    }

    .filtros-row button {
      flex: 1;
      min-width: 120px;
    }

    /* Modal de edici√≥n */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid var(--glass-border);
      padding: 24px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: modalIn 0.3s ease-out;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(135deg, #10b981, #059669);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .btn-close-modal {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-close-modal:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .modal-actions button {
      flex: 1;
    }

    .btn-edit {
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid var(--glass-border);
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-edit:hover {
      background: rgba(245, 158, 11, 0.3);
    }

    /* Multi-select costuras y tallas */
    .check-group { margin: 8px 0; }
    .check-item {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 8px;
      background: rgba(255,255,255,0.04); margin-bottom: 4px;
      cursor: pointer; font-size: 13px; transition: background 0.2s;
    }
    .check-item:hover { background: rgba(59,130,246,0.1); }
    .check-item input[type="checkbox"] {
      width: 18px; height: 18px; accent-color: #3b82f6; cursor: pointer; flex-shrink: 0;
    }
    .check-item .check-label { flex: 1; }
    .check-item .check-detail { color: var(--text-muted); font-size: 11px; }

    .talla-row {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 8px;
      background: rgba(255,255,255,0.04); margin-bottom: 4px;
    }
    .talla-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: #3b82f6; flex-shrink: 0; }
    .talla-row .talla-name { font-weight: 600; min-width: 50px; font-size: 13px; }
    .talla-row .talla-cant {
      width: 70px; padding: 6px 8px; border-radius: 6px;
      background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border);
      color: var(--text-main); font-size: 13px; text-align: center;
    }
    .talla-row .talla-cant:disabled { opacity: 0.3; }
    .talla-row .faltante-info { color: var(--text-muted); font-size: 11px; margin-left: auto; }

    .resumen-lote {
      padding: 10px 14px; border-radius: 10px;
      background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2);
      font-size: 13px; color: #93c5fd; margin: 10px 0; text-align: center;
    }
    .section-label {
      font-size: 12px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px; margin: 12px 0 6px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <button class="btn-back" id="btn-volver">‚Üê</button>
      <div class="header-info">
        <h1 id="titulo-pagina">Producci√≥n</h1>
        <span>Usuario: <strong id="nombre-usuario"></strong></span>
      </div>
    </header>

    <main>
      <div class="mensaje-error" id="mensaje-error"></div>
      <div class="mensaje-exito" id="mensaje-exito"></div>

      <!-- VISTA OPERARIA: Formulario de registro -->
      <div id="vista-operaria" class="oculto">
        <section class="card">
          <div class="card-title">‚úÇÔ∏è Registrar Costura</div>
          <p class="subtext">Selecciona costuras y tallas ‚Äî se guardan todos de un golpe</p>

          <div class="form-row">
            <label for="select-pedido">üì¶ Pedido</label>
            <select id="select-pedido">
              <option value="">-- Selecciona un pedido --</option>
            </select>
          </div>

          <div class="form-row">
            <label for="select-prenda">üß• Prenda</label>
            <select id="select-prenda">
              <option value="">-- Primero selecciona un pedido --</option>
            </select>
          </div>

          <!-- Multi-select costuras -->
          <div id="costuras-container" class="oculto">
            <div class="section-label">‚úÇÔ∏è Costuras a registrar</div>
            <div id="lista-costuras-check" class="check-group"></div>
          </div>

          <!-- Multi-select tallas con cantidades -->
          <div id="tallas-container" class="oculto">
            <div class="section-label">üìè Tallas y cantidades</div>
            <div id="lista-tallas-check"></div>
          </div>

          <!-- Modo manual (toggle) -->
          <div id="manual-toggle" class="oculto" style="margin:10px 0;">
            <label class="check-item" style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);">
              <input type="checkbox" id="check-manual">
              <span>‚úèÔ∏è Modo manual (costura no listada)</span>
            </label>
          </div>
          <div id="manual-fields" class="oculto">
            <div class="form-row">
              <label for="input-descripcion-manual">‚úèÔ∏è Descripci√≥n</label>
              <input type="text" id="input-descripcion-manual" placeholder="Ej: pegar bolsa, bastilla..." />
            </div>
            <div class="form-row">
              <label for="select-maquina">üîß M√°quina</label>
              <select id="select-maquina">
                <option value="">-- Selecciona --</option>
              </select>
            </div>
            <div class="form-row">
              <label for="input-cantidad-manual">üî¢ Cantidad</label>
              <input type="number" id="input-cantidad-manual" placeholder="0" min="1" />
            </div>
          </div>

          <div id="resumen-lote" class="resumen-lote oculto"></div>

          <button class="btn-primary" id="btn-guardar">üíæ Guardar Costura</button>
        </section>

        <!-- Mis costuras (solo operaria ve las suyas) -->
        <section class="card">
          <div class="card-title">üìã Mis Costuras Recientes</div>
          <p class="subtext">Puedes editar tus costuras antes de que se asigne el precio</p>
          <div id="lista-mis-costuras"></div>
        </section>
      </div>

      <!-- VISTA ENCARGADA: Formulario con selector de operaria -->
      <div id="vista-encargada" class="oculto">
        <section class="card">
          <div class="card-title">üë§ Registrar Costura</div>
          <p class="subtext">Selecciona costuras y tallas para la operaria</p>

          <div class="form-row">
            <label for="select-operaria-enc">üë• Operaria</label>
            <select id="select-operaria-enc">
              <option value="">-- Selecciona una operaria --</option>
            </select>
          </div>

          <div class="form-row">
            <label for="select-pedido-enc">üì¶ Pedido</label>
            <select id="select-pedido-enc">
              <option value="">-- Selecciona un pedido --</option>
            </select>
          </div>

          <div class="form-row">
            <label for="select-prenda-enc">üß• Prenda</label>
            <select id="select-prenda-enc">
              <option value="">-- Primero selecciona un pedido --</option>
            </select>
          </div>

          <div id="costuras-container-enc" class="oculto">
            <div class="section-label">‚úÇÔ∏è Costuras a registrar</div>
            <div id="lista-costuras-check-enc" class="check-group"></div>
          </div>

          <div id="tallas-container-enc" class="oculto">
            <div class="section-label">üìè Tallas y cantidades</div>
            <div id="lista-tallas-check-enc"></div>
          </div>

          <div id="manual-toggle-enc" class="oculto" style="margin:10px 0;">
            <label class="check-item" style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);">
              <input type="checkbox" id="check-manual-enc">
              <span>‚úèÔ∏è Modo manual (costura no listada)</span>
            </label>
          </div>
          <div id="manual-fields-enc" class="oculto">
            <div class="form-row">
              <label for="input-descripcion-manual-enc">‚úèÔ∏è Descripci√≥n</label>
              <input type="text" id="input-descripcion-manual-enc" placeholder="Ej: pegar bolsa, bastilla..." />
            </div>
            <div class="form-row">
              <label for="select-maquina-enc">üîß M√°quina</label>
              <select id="select-maquina-enc">
                <option value="">-- Selecciona --</option>
              </select>
            </div>
            <div class="form-row">
              <label for="input-cantidad-manual-enc">üî¢ Cantidad</label>
              <input type="number" id="input-cantidad-manual-enc" placeholder="0" min="1" />
            </div>
          </div>

          <div id="resumen-lote-enc" class="resumen-lote oculto"></div>

          <button class="btn-primary" id="btn-guardar-enc">üíæ Guardar Costura</button>
        </section>
      </div>

      <!-- VISTA ADMIN: Lista de costuras con SEPARACI√ìN DE FUENTES -->
      <div id="vista-admin" class="oculto">
        <section class="card">
          <div class="card-title">üìä Gesti√≥n de Costuras</div>
          <p class="subtext">Asigna precios y gestiona las costuras (bases de datos separadas)</p>
          
          <div class="filtros-row">
            <select id="filtro-estado">
              <option value="pendiente">Sin precio asignado</option>
              <option value="todos">Todas las costuras</option>
            </select>

            <select id="filtro-operaria">
              <option value="">Todas las operarias</option>
            </select>
          </div>

          <!-- FILTRO DE FUENTE: SEPARACI√ìN DE BASES DE DATOS -->
          <div class="filtros-row">
            <button class="btn-secondary active" id="filtro-fuente-operaria">üë©‚Äçüè≠ Registros Operarias</button>
            <button class="btn-secondary" id="filtro-fuente-encargada">üë§ Registros Encargada</button>
          </div>
          
          <div id="lista-costuras-admin"></div>
        </section>
      </div>
    </main>

    <!-- Modal de Edici√≥n -->
    <div class="modal-overlay" id="modal-editar">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">‚úèÔ∏è Editar Costura</div>
          <button class="btn-close-modal" id="btn-cerrar-modal">√ó</button>
        </div>

        <div class="form-row">
          <label for="edit-pedido">üì¶ Pedido</label>
          <select id="edit-pedido"></select>
        </div>

        <div class="form-row">
          <label for="edit-prenda">üß• Prenda</label>
          <select id="edit-prenda"></select>
        </div>

        <div class="form-row">
          <label for="edit-maquina">üîß M√°quina</label>
          <select id="edit-maquina"></select>
        </div>

        <div class="form-row">
          <label for="edit-descripcion">üìù Descripci√≥n</label>
          <textarea id="edit-descripcion"></textarea>
        </div>

        <div class="form-row">
          <label for="edit-cantidad">üî¢ Cantidad</label>
          <input type="number" id="edit-cantidad" min="1" />
        </div>

        <div class="modal-actions">
          <button class="btn-danger" id="btn-cancelar-edit">‚ùå Cancelar</button>
          <button class="btn-primary" id="btn-guardar-edit">üíæ Guardar Cambios</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Validar sesi√≥n
      let usuarioActual;
      try {
        const dataUsuario = localStorage.getItem("usuarioActual");
        if (!dataUsuario) throw new Error("No hay sesi√≥n");
        usuarioActual = JSON.parse(dataUsuario);
        if (!usuarioActual.tipo || !usuarioActual.nombre) throw new Error("Sesi√≥n inv√°lida");
      } catch (err) {
        console.error("Error de sesi√≥n:", err);
        localStorage.removeItem("usuarioActual");
        alert("Sesi√≥n inv√°lida. Por favor inicia sesi√≥n nuevamente.");
        window.location.href = "/login.html";
        return;
      }

      // Elementos DOM
      const spanNombreUsuario = document.getElementById("nombre-usuario");
      const tituloPagina = document.getElementById("titulo-pagina");
      const vistaOperaria = document.getElementById("vista-operaria");
      const vistaEncargada = document.getElementById("vista-encargada");
      const vistaAdmin = document.getElementById("vista-admin");
      const mensajeError = document.getElementById("mensaje-error");
      const mensajeExito = document.getElementById("mensaje-exito");
      const btnVolver = document.getElementById("btn-volver");

      let filtroFuenteActual = "operaria"; // "operaria" o "encargada"

      if (spanNombreUsuario) spanNombreUsuario.textContent = usuarioActual.nombre || "";

      // Determinar vista seg√∫n rol
      if (usuarioActual.tipo === "admin") {
        // Admin no debe estar aqu√≠, redirigir a producci√≥n
        window.location.href = "/produccion";
        return;
      } else if (usuarioActual.tipo === "encargada") {
        tituloPagina.textContent = "Registrar Costura";
        vistaEncargada.classList.remove("oculto");
        await inicializarVistaEncargada();
      } else if (usuarioActual.tipo === "operaria") {
        tituloPagina.textContent = "Registrar Costura";
        vistaOperaria.classList.remove("oculto");
        await inicializarVistaOperaria();
      }

      // Funciones auxiliares
      function mostrarError(mensaje) {
        mensajeError.textContent = mensaje;
        mensajeError.style.display = "block";
        mensajeExito.style.display = "none";
        setTimeout(() => { mensajeError.style.display = "none"; }, 5000);
      }

      function mostrarExito(mensaje) {
        mensajeExito.textContent = mensaje;
        mensajeExito.style.display = "block";
        mensajeError.style.display = "none";
        setTimeout(() => { mensajeExito.style.display = "none"; }, 3000);
      }

      // ==========================================
      // VISTA OPERARIA
      // ==========================================
      async function inicializarVistaOperaria() {
        await cargarPedidosActivos("select-pedido");
        await cargarMaquinas("select-maquina");
        await cargarMisCosturas();

        let pedidoCache = null;
        let operacionesCache = [];

        // Pedido change ‚Üí load prendas
        document.getElementById("select-pedido").addEventListener("change", async (e) => {
          const pedidoId = e.target.value;
          const selectPrenda = document.getElementById("select-prenda");
          ocultarMultiSelect();
          if (!pedidoId) { selectPrenda.innerHTML = '<option value="">-- Primero selecciona un pedido --</option>'; return; }
          try {
            const res = await fetch(`/api/pedidos/${pedidoId}`);
            const pedido = await res.json();
            pedidoCache = pedido;
            window._pedidoActual = pedido;
            if (pedido.items && pedido.items.length > 0) {
              const resPrendas = await fetch("/api/prendas");
              const todasPrendas = await resPrendas.json();
              selectPrenda.innerHTML = '<option value="">-- Selecciona una prenda --</option>';
              pedido.items.forEach(item => {
                const prenda = todasPrendas.find(p => p.id === item.prendaId);
                if (prenda) {
                  const opt = document.createElement("option");
                  opt.value = prenda.id;
                  opt.textContent = `${prenda.nombre} (${item.cantidad} pzas)`;
                  selectPrenda.appendChild(opt);
                }
              });
            } else {
              selectPrenda.innerHTML = '<option value="">-- Este pedido no tiene prendas --</option>';
            }
          } catch (err) { console.error("Error cargando prendas:", err); }
        });

        // Prenda change ‚Üí load costuras checkboxes + tallas rows
        document.getElementById("select-prenda").addEventListener("change", async (e) => {
          const prendaId = e.target.value;
          const pedidoId = document.getElementById("select-pedido").value;
          if (!prendaId || !pedidoId) { ocultarMultiSelect(); return; }
          await cargarCosturasYTallasOp(pedidoId, prendaId);
        });

        async function cargarCosturasYTallasOp(pedidoId, prendaId) {
          try {
            // Fetch operaciones con precio > 0
            const res = await fetch(`/api/pedidos/${pedidoId}/operaciones?prendaId=${prendaId}&soloConPrecio=true&fuente=operaria`);
            const ops = await res.json();
            operacionesCache = ops;

            // Render costuras checkboxes (agrupar por costura+maquina, sin duplicados por talla)
            const costurasUnicas = [];
            const vistos = new Set();
            ops.forEach(op => {
              const key = `${op.opId}`;
              if (!vistos.has(key)) {
                vistos.add(key);
                costurasUnicas.push(op);
              }
            });

            const listaCosturas = document.getElementById("lista-costuras-check");
            if (costurasUnicas.length === 0) {
              listaCosturas.innerHTML = '<p style="color:var(--text-muted);font-size:12px;">No hay costuras con precio asignado para esta prenda</p>';
            } else {
              listaCosturas.innerHTML = costurasUnicas.map(op => `
                <label class="check-item">
                  <input type="checkbox" value="${op.opId}" data-costura="${op.costura}" data-maquina="${op.maquina}" data-precio="${op.precio}" onchange="actualizarResumenOp()">
                  <span class="check-label">${op.costura} <span class="check-detail">(${op.maquina})</span></span>
                </label>
              `).join("");
            }
            document.getElementById("costuras-container").classList.remove("oculto");

            // Render tallas
            const item = pedidoCache && pedidoCache.items ? pedidoCache.items.find(i => Number(i.prendaId) === Number(prendaId)) : null;
            const listaTallas = document.getElementById("lista-tallas-check");
            if (item && Array.isArray(item.tallas) && item.tallas.length > 0) {
              listaTallas.innerHTML = item.tallas.map(t => `
                <div class="talla-row">
                  <input type="checkbox" value="${t.talla}" onchange="toggleTallaCantOp(this)">
                  <span class="talla-name">T-${t.talla}</span>
                  <input type="number" class="talla-cant" data-talla="${t.talla}" placeholder="Cant." min="1" max="${t.cantidad}" oninput="actualizarResumenOp()" disabled>
                  <span class="faltante-info">de ${t.cantidad}</span>
                </div>
              `).join("");
              document.getElementById("tallas-container").classList.remove("oculto");
            } else {
              listaTallas.innerHTML = `
                <div class="talla-row">
                  <input type="checkbox" value="" checked disabled>
                  <span class="talla-name">Sin tallas</span>
                  <input type="number" class="talla-cant" data-talla="" placeholder="Cant." min="1" oninput="actualizarResumenOp()">
                  <span class="faltante-info">de ${item ? item.cantidad : '?'}</span>
                </div>
              `;
              document.getElementById("tallas-container").classList.remove("oculto");
            }

            document.getElementById("manual-toggle").classList.remove("oculto");
            actualizarResumenOp();
          } catch (err) { console.error("Error cargando costuras/tallas:", err); }
        }

        // Exponer para recargar despu√©s de eliminar/editar
        window._recargarOperacionesOp = async function() {
          const prendaId = document.getElementById("select-prenda").value;
          const pedidoId = document.getElementById("select-pedido").value;
          if (prendaId && pedidoId) await cargarCosturasYTallasOp(pedidoId, prendaId);
        };

        // Manual mode toggle
        document.getElementById("check-manual").addEventListener("change", (e) => {
          const manualFields = document.getElementById("manual-fields");
          const costurasContainer = document.getElementById("costuras-container");
          if (e.target.checked) {
            manualFields.classList.remove("oculto");
            costurasContainer.classList.add("oculto");
          } else {
            manualFields.classList.add("oculto");
            costurasContainer.classList.remove("oculto");
          }
          actualizarResumenOp();
        });

        document.getElementById("btn-guardar").addEventListener("click", () => guardarLoteOperaria());

        function ocultarMultiSelect() {
          document.getElementById("costuras-container").classList.add("oculto");
          document.getElementById("tallas-container").classList.add("oculto");
          document.getElementById("manual-toggle").classList.add("oculto");
          document.getElementById("manual-fields").classList.add("oculto");
          document.getElementById("resumen-lote").classList.add("oculto");
          document.getElementById("check-manual").checked = false;
        }
      }

      // Helpers globales para operaria
      window.toggleTallaCantOp = function(cb) {
        const row = cb.closest(".talla-row");
        const cantInput = row.querySelector(".talla-cant");
        cantInput.disabled = !cb.checked;
        if (!cb.checked) cantInput.value = "";
        actualizarResumenOp();
      };

      window.actualizarResumenOp = function() {
        const esManual = document.getElementById("check-manual").checked;
        const resumenDiv = document.getElementById("resumen-lote");
        if (esManual) {
          const cant = Number(document.getElementById("input-cantidad-manual").value) || 0;
          const tallasChecked = document.querySelectorAll("#lista-tallas-check input[type='checkbox']:checked");
          const tallasConCant = [...tallasChecked].filter(cb => {
            const row = cb.closest(".talla-row");
            return Number(row.querySelector(".talla-cant").value) > 0;
          });
          const n = tallasConCant.length > 0 ? tallasConCant.length : (cant > 0 ? 1 : 0);
          resumenDiv.textContent = n > 0 ? `Se crear√° ${n} registro(s) en modo manual` : "Completa los campos";
          resumenDiv.classList.remove("oculto");
          return;
        }
        const costurasChecked = document.querySelectorAll("#lista-costuras-check input[type='checkbox']:checked");
        const tallasChecked = document.querySelectorAll("#lista-tallas-check input[type='checkbox']:checked");
        let totalRegs = 0;
        tallasChecked.forEach(cb => {
          const row = cb.closest(".talla-row");
          const cant = Number(row.querySelector(".talla-cant").value);
          if (cant > 0) totalRegs += costurasChecked.length;
        });
        if (totalRegs > 0) {
          resumenDiv.textContent = `Se crear√°n ${totalRegs} registro(s): ${costurasChecked.length} costura(s) √ó ${[...tallasChecked].filter(cb => Number(cb.closest(".talla-row").querySelector(".talla-cant").value) > 0).length} talla(s)`;
          resumenDiv.classList.remove("oculto");
        } else {
          resumenDiv.textContent = "Selecciona costuras y escribe cantidades";
          resumenDiv.classList.remove("oculto");
        }
      };

      async function guardarLoteOperaria() {
        const pedidoId = document.getElementById("select-pedido").value;
        const prendaId = document.getElementById("select-prenda").value;
        const esManual = document.getElementById("check-manual").checked;
        const btn = document.getElementById("btn-guardar");

        if (!pedidoId || !prendaId) { mostrarError("‚ùå Selecciona pedido y prenda"); return; }

        btn.disabled = true;
        btn.textContent = "‚è≥ Guardando...";

        try {
          const items = [];
          const tallasChecked = document.querySelectorAll("#lista-tallas-check input[type='checkbox']:checked");

          if (esManual) {
            const descripcion = (document.getElementById("input-descripcion-manual").value || "").trim();
            const maquina = document.getElementById("select-maquina").value;
            if (!descripcion || !maquina) { mostrarError("‚ùå Completa descripci√≥n y m√°quina"); return; }
            tallasChecked.forEach(cb => {
              const row = cb.closest(".talla-row");
              const cant = Number(row.querySelector(".talla-cant").value);
              if (cant > 0) {
                items.push({
                  operariaId: usuarioActual.id,
                  pedidoId: Number(pedidoId),
                  prendaId: Number(prendaId),
                  talla: cb.value || null,
                  maquina, descripcion, cantidad: cant,
                  pagoPorPieza: 0, fuente: "operaria"
                });
              }
            });
          } else {
            const costurasChecked = document.querySelectorAll("#lista-costuras-check input[type='checkbox']:checked");
            if (costurasChecked.length === 0) { mostrarError("‚ùå Selecciona al menos una costura"); return; }
            costurasChecked.forEach(costCb => {
              tallasChecked.forEach(tallaCb => {
                const row = tallaCb.closest(".talla-row");
                const cant = Number(row.querySelector(".talla-cant").value);
                if (cant > 0) {
                  items.push({
                    operariaId: usuarioActual.id,
                    pedidoId: Number(pedidoId),
                    prendaId: Number(prendaId),
                    operacionId: Number(costCb.value),
                    talla: tallaCb.value || null,
                    maquina: costCb.dataset.maquina,
                    descripcion: costCb.dataset.costura,
                    cantidad: cant,
                    pagoPorPieza: 0, fuente: "operaria"
                  });
                }
              });
            });
          }

          if (items.length === 0) { mostrarError("‚ùå No hay registros para guardar ‚Äî verifica cantidades"); return; }

          const res = await fetch("/api/registros/lote", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ items })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Error al guardar");

          let msg = `‚úÖ ${data.creados} registro(s) guardado(s)`;
          if (data.errores && data.errores.length > 0) {
            msg += `\n‚ö†Ô∏è ${data.errores.length} error(es): ${data.errores.map(e => e.error).join(", ")}`;
          }
          mostrarExito(msg);

          // Limpiar cantidades
          document.querySelectorAll("#lista-tallas-check .talla-cant").forEach(inp => inp.value = "");
          document.querySelectorAll("#lista-costuras-check input[type='checkbox']").forEach(cb => cb.checked = false);

          await cargarMisCosturas();
          if (typeof window._recargarOperacionesOp === 'function') await window._recargarOperacionesOp();
        } catch (err) {
          mostrarError("‚ùå " + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = "üíæ Guardar Costura";
        }
      }

      async function cargarMisCosturas() {
        try {
          const url = `/api/registros?operariaId=${usuarioActual.id}&fuente=operaria&estadoPago=pendiente`;
          const res = await fetch(url);
          if (!res.ok) throw new Error("Error al cargar costuras");
          const registros = await res.json();
          const lista = document.getElementById("lista-mis-costuras");
          if (registros.length === 0) {
            lista.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No tienes costuras registradas</p>';
            return;
          }
          const registrosOrdenados = registros.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
          lista.innerHTML = registrosOrdenados.slice(0, 5).map(r => `
            <div class="costura-item">
              <div class="costura-info">
                <strong>${r.escuela || "Pedido"}</strong> - ${r.prenda || r.prendaNombre || "Prenda"}${r.talla ? ` (T-${r.talla})` : ''} - ${r.descripcion}
              </div>
              <div class="costura-info">
                üì¶ Cantidad: <strong>${r.cantidad} piezas</strong> | üîß ${r.maquina}
              </div>
              <div class="costura-info">
                üìÖ ${new Date(r.fecha).toLocaleDateString("es-MX")}
                ${r.pagoPorPieza > 0 ?
                  `<span class="badge badge-success">Precio: $${r.pagoPorPieza.toFixed(2)}</span>` :
                  `<span class="badge badge-warning">Sin precio</span>`
                }
              </div>
              ${r.pagoPorPieza === 0 ? `
                <div class="costura-actions">
                  <button class="btn-edit" onclick="abrirModalEditar(${r.id})">‚úèÔ∏è Editar</button>
                  <button class="btn-danger" onclick="eliminarCostura(${r.id})">üóëÔ∏è Eliminar</button>
                </div>
              ` : ''}
            </div>
          `).join("");
        } catch (err) {
          console.error("‚ùå Error cargando mis costuras:", err);
          mostrarError("Error cargando costuras: " + err.message);
        }
      }

      // ==========================================
      // VISTA ENCARGADA
      // ==========================================
      async function inicializarVistaEncargada() {
        await cargarOperarias("select-operaria-enc");
        await cargarPedidosActivos("select-pedido-enc");
        await cargarMaquinas("select-maquina-enc");

        let pedidoCacheEnc = null;

        document.getElementById("select-pedido-enc").addEventListener("change", async (e) => {
          const pedidoId = e.target.value;
          const selectPrenda = document.getElementById("select-prenda-enc");
          ocultarMultiSelectEnc();
          if (!pedidoId) { selectPrenda.innerHTML = '<option value="">-- Primero selecciona un pedido --</option>'; return; }
          try {
            const res = await fetch(`/api/pedidos/${pedidoId}`);
            const pedido = await res.json();
            pedidoCacheEnc = pedido;
            window._pedidoActualEnc = pedido;
            if (pedido.items && pedido.items.length > 0) {
              const resPrendas = await fetch("/api/prendas");
              const todasPrendas = await resPrendas.json();
              selectPrenda.innerHTML = '<option value="">-- Selecciona una prenda --</option>';
              pedido.items.forEach(item => {
                const prenda = todasPrendas.find(p => p.id === item.prendaId);
                if (prenda) {
                  const opt = document.createElement("option");
                  opt.value = prenda.id;
                  opt.textContent = `${prenda.nombre} (${item.cantidad} pzas)`;
                  selectPrenda.appendChild(opt);
                }
              });
            } else {
              selectPrenda.innerHTML = '<option value="">-- Este pedido no tiene prendas --</option>';
            }
          } catch (err) { console.error("Error cargando prendas:", err); }
        });

        document.getElementById("select-prenda-enc").addEventListener("change", async (e) => {
          const prendaId = e.target.value;
          const pedidoId = document.getElementById("select-pedido-enc").value;
          if (!prendaId || !pedidoId) { ocultarMultiSelectEnc(); return; }
          await cargarCosturasYTallasEnc(pedidoId, prendaId);
        });

        async function cargarCosturasYTallasEnc(pedidoId, prendaId) {
          try {
            const res = await fetch(`/api/pedidos/${pedidoId}/operaciones?prendaId=${prendaId}&soloConPrecio=true&fuente=encargada`);
            const ops = await res.json();

            const costurasUnicas = [];
            const vistos = new Set();
            ops.forEach(op => {
              if (!vistos.has(`${op.opId}`)) { vistos.add(`${op.opId}`); costurasUnicas.push(op); }
            });

            const listaCosturas = document.getElementById("lista-costuras-check-enc");
            if (costurasUnicas.length === 0) {
              listaCosturas.innerHTML = '<p style="color:var(--text-muted);font-size:12px;">No hay costuras con precio asignado</p>';
            } else {
              listaCosturas.innerHTML = costurasUnicas.map(op => `
                <label class="check-item">
                  <input type="checkbox" value="${op.opId}" data-costura="${op.costura}" data-maquina="${op.maquina}" data-precio="${op.precio}" onchange="actualizarResumenEnc()">
                  <span class="check-label">${op.costura} <span class="check-detail">(${op.maquina})</span></span>
                </label>
              `).join("");
            }
            document.getElementById("costuras-container-enc").classList.remove("oculto");

            const item = pedidoCacheEnc && pedidoCacheEnc.items ? pedidoCacheEnc.items.find(i => Number(i.prendaId) === Number(prendaId)) : null;
            const listaTallas = document.getElementById("lista-tallas-check-enc");
            if (item && Array.isArray(item.tallas) && item.tallas.length > 0) {
              listaTallas.innerHTML = item.tallas.map(t => `
                <div class="talla-row">
                  <input type="checkbox" value="${t.talla}" onchange="toggleTallaCantEnc(this)">
                  <span class="talla-name">T-${t.talla}</span>
                  <input type="number" class="talla-cant" data-talla="${t.talla}" placeholder="Cant." min="1" max="${t.cantidad}" oninput="actualizarResumenEnc()" disabled>
                  <span class="faltante-info">de ${t.cantidad}</span>
                </div>
              `).join("");
              document.getElementById("tallas-container-enc").classList.remove("oculto");
            } else {
              listaTallas.innerHTML = `
                <div class="talla-row">
                  <input type="checkbox" value="" checked disabled>
                  <span class="talla-name">Sin tallas</span>
                  <input type="number" class="talla-cant" data-talla="" placeholder="Cant." min="1" oninput="actualizarResumenEnc()">
                  <span class="faltante-info">de ${item ? item.cantidad : '?'}</span>
                </div>
              `;
              document.getElementById("tallas-container-enc").classList.remove("oculto");
            }

            document.getElementById("manual-toggle-enc").classList.remove("oculto");
            actualizarResumenEnc();
          } catch (err) { console.error("Error cargando costuras/tallas enc:", err); }
        }

        window._recargarOperacionesEnc = async function() {
          const prendaId = document.getElementById("select-prenda-enc").value;
          const pedidoId = document.getElementById("select-pedido-enc").value;
          if (prendaId && pedidoId) await cargarCosturasYTallasEnc(pedidoId, prendaId);
        };

        document.getElementById("check-manual-enc").addEventListener("change", (e) => {
          const manualFields = document.getElementById("manual-fields-enc");
          const costurasContainer = document.getElementById("costuras-container-enc");
          if (e.target.checked) { manualFields.classList.remove("oculto"); costurasContainer.classList.add("oculto"); }
          else { manualFields.classList.add("oculto"); costurasContainer.classList.remove("oculto"); }
          actualizarResumenEnc();
        });

        document.getElementById("btn-guardar-enc").addEventListener("click", () => guardarLoteEncargada());

        function ocultarMultiSelectEnc() {
          ["costuras-container-enc","tallas-container-enc","manual-toggle-enc","manual-fields-enc","resumen-lote-enc"].forEach(id => document.getElementById(id).classList.add("oculto"));
          document.getElementById("check-manual-enc").checked = false;
        }
      }

      window.toggleTallaCantEnc = function(cb) {
        const row = cb.closest(".talla-row");
        const cantInput = row.querySelector(".talla-cant");
        cantInput.disabled = !cb.checked;
        if (!cb.checked) cantInput.value = "";
        actualizarResumenEnc();
      };

      window.actualizarResumenEnc = function() {
        const esManual = document.getElementById("check-manual-enc").checked;
        const resumenDiv = document.getElementById("resumen-lote-enc");
        const tallasChecked = document.querySelectorAll("#lista-tallas-check-enc input[type='checkbox']:checked");
        if (esManual) {
          const tallasConCant = [...tallasChecked].filter(cb => { const row = cb.closest(".talla-row"); return Number(row.querySelector(".talla-cant").value) > 0; });
          resumenDiv.textContent = tallasConCant.length > 0 ? `Se crear√° ${tallasConCant.length} registro(s) manual(es)` : "Completa los campos";
        } else {
          const costurasChecked = document.querySelectorAll("#lista-costuras-check-enc input[type='checkbox']:checked");
          let totalRegs = 0;
          tallasChecked.forEach(cb => { const cant = Number(cb.closest(".talla-row").querySelector(".talla-cant").value); if (cant > 0) totalRegs += costurasChecked.length; });
          resumenDiv.textContent = totalRegs > 0 ? `Se crear√°n ${totalRegs} registro(s)` : "Selecciona costuras y cantidades";
        }
        resumenDiv.classList.remove("oculto");
      };

      async function guardarLoteEncargada() {
        const operariaId = document.getElementById("select-operaria-enc").value;
        const pedidoId = document.getElementById("select-pedido-enc").value;
        const prendaId = document.getElementById("select-prenda-enc").value;
        const esManual = document.getElementById("check-manual-enc").checked;
        const btn = document.getElementById("btn-guardar-enc");

        if (!operariaId) { mostrarError("‚ùå Selecciona una operaria"); return; }
        if (!pedidoId || !prendaId) { mostrarError("‚ùå Selecciona pedido y prenda"); return; }

        btn.disabled = true;
        btn.textContent = "‚è≥ Guardando...";

        try {
          const items = [];
          const tallasChecked = document.querySelectorAll("#lista-tallas-check-enc input[type='checkbox']:checked");

          if (esManual) {
            const descripcion = (document.getElementById("input-descripcion-manual-enc").value || "").trim();
            const maquina = document.getElementById("select-maquina-enc").value;
            if (!descripcion || !maquina) { mostrarError("‚ùå Completa descripci√≥n y m√°quina"); return; }
            tallasChecked.forEach(cb => {
              const cant = Number(cb.closest(".talla-row").querySelector(".talla-cant").value);
              if (cant > 0) {
                items.push({
                  operariaId: Number(operariaId), pedidoId: Number(pedidoId), prendaId: Number(prendaId),
                  talla: cb.value || null, maquina, descripcion, cantidad: cant, pagoPorPieza: 0, fuente: "encargada"
                });
              }
            });
          } else {
            const costurasChecked = document.querySelectorAll("#lista-costuras-check-enc input[type='checkbox']:checked");
            if (costurasChecked.length === 0) { mostrarError("‚ùå Selecciona al menos una costura"); return; }
            costurasChecked.forEach(costCb => {
              tallasChecked.forEach(tallaCb => {
                const cant = Number(tallaCb.closest(".talla-row").querySelector(".talla-cant").value);
                if (cant > 0) {
                  items.push({
                    operariaId: Number(operariaId), pedidoId: Number(pedidoId), prendaId: Number(prendaId),
                    operacionId: Number(costCb.value), talla: tallaCb.value || null,
                    maquina: costCb.dataset.maquina, descripcion: costCb.dataset.costura,
                    cantidad: cant, pagoPorPieza: 0, fuente: "encargada"
                  });
                }
              });
            });
          }

          if (items.length === 0) { mostrarError("‚ùå No hay registros ‚Äî verifica cantidades"); return; }

          const res = await fetch("/api/registros/lote", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ items })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Error al guardar");

          let msg = `‚úÖ ${data.creados} registro(s) guardado(s)`;
          if (data.errores && data.errores.length > 0) msg += `\n‚ö†Ô∏è ${data.errores.map(e => e.error).join(", ")}`;
          mostrarExito(msg);

          document.querySelectorAll("#lista-tallas-check-enc .talla-cant").forEach(inp => inp.value = "");
          document.querySelectorAll("#lista-costuras-check-enc input[type='checkbox']").forEach(cb => cb.checked = false);
          if (typeof window._recargarOperacionesEnc === 'function') await window._recargarOperacionesEnc();
        } catch (err) {
          mostrarError("‚ùå " + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = "üíæ Guardar Costura";
        }
      }

      // ==========================================
      // VISTA ADMIN - SEPARACI√ìN DE BASES DE DATOS
      // ==========================================
      async function inicializarVistaAdmin() {
        await cargarOperariasParaFiltro();
        await cargarCosturasAdmin();
        
        document.getElementById("filtro-estado").addEventListener("change", cargarCosturasAdmin);
        document.getElementById("filtro-operaria").addEventListener("change", cargarCosturasAdmin);
        
        // FILTROS DE FUENTE: SEPARAR BASES DE DATOS
        document.getElementById("filtro-fuente-operaria").addEventListener("click", () => {
          cambiarFiltroFuente("operaria");
        });
        
        document.getElementById("filtro-fuente-encargada").addEventListener("click", () => {
          cambiarFiltroFuente("encargada");
        });
      }

      function cambiarFiltroFuente(fuente) {
        filtroFuenteActual = fuente;
        
        // Actualizar botones activos
        document.getElementById("filtro-fuente-operaria").classList.toggle("active", fuente === "operaria");
        document.getElementById("filtro-fuente-encargada").classList.toggle("active", fuente === "encargada");
        
        cargarCosturasAdmin();
      }

      async function cargarOperariasParaFiltro() {
        try {
          const res = await fetch("/api/operarias");
          if (!res.ok) throw new Error("Error al cargar operarias");
          const operarias = await res.json();
          
          const select = document.getElementById("filtro-operaria");
          select.innerHTML = '<option value="">Todas las operarias</option>';
          
          operarias.filter(op => op.activa).forEach(op => {
            const option = document.createElement("option");
            option.value = op.id;
            option.textContent = op.nombre;
            select.appendChild(option);
          });
        } catch (err) {
          console.error("Error cargando operarias:", err);
        }
      }

      async function cargarCosturasAdmin() {
        try {
          const filtroEstado = document.getElementById("filtro-estado").value;
          const filtroOperaria = document.getElementById("filtro-operaria").value;
          
          const estadoPago = filtroEstado === "todos" ? "todos" : "pendiente";
          
          // FILTRAR POR FUENTE: SEPARACI√ìN DE BASES DE DATOS
          let url = `/api/registros?estadoPago=${estadoPago}&fuente=${filtroFuenteActual}`;
          if (filtroOperaria) {
            url += `&operariaId=${filtroOperaria}`;
          }
          
          const res = await fetch(url);
          if (!res.ok) throw new Error("Error al cargar costuras");
          
          const registros = await res.json();
          const lista = document.getElementById("lista-costuras-admin");
          
          if (registros.length === 0) {
            lista.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No hay costuras</p>';
            return;
          }

          lista.innerHTML = registros.map(r => `
            <div class="costura-item">
              <div class="costura-header">
                <div>
                  <div class="costura-operaria">${r.operariaNombre}</div>
                  <div class="costura-fecha">${new Date(r.fecha).toLocaleDateString("es-MX")}</div>
                </div>
                <div>
                  ${r.pagoPorPieza > 0 ? 
                    `<span class="badge badge-success">$${r.totalGanado.toFixed(2)}</span>` : 
                    `<span class="badge badge-warning">Sin precio</span>`
                  }
                  <span class="badge ${r.fuente === 'encargada' ? 'badge-encargada' : 'badge-operaria'}">
                    ${r.fuente === 'encargada' ? 'üë§ Encargada' : 'üë©‚Äçüè≠ Operaria'}
                  </span>
                </div>
              </div>
              
              <div class="costura-info">
                <strong>${r.escuela || "Pedido"}</strong> - ${r.prenda || r.prendaNombre || "Prenda"}${r.talla ? ` (T-${r.talla})` : ''} - ${r.descripcion}
              </div>
              <div class="costura-info">
                üì¶ Cantidad: <strong>${r.cantidad} piezas</strong> | üîß ${r.maquina}
              </div>
              
              ${r.pagoPorPieza === 0 ? `
                <div class="precio-input">
                  <input 
                    type="number" 
                    id="precio-${r.id}" 
                    placeholder="Precio por pieza" 
                    step="0.01" 
                    min="0"
                  />
                  <button class="btn-secondary" onclick="asignarPrecio(${r.id})">üí∞ Asignar</button>
                </div>
                <div class="costura-actions">
                  <button class="btn-edit" onclick="abrirModalEditar(${r.id})">‚úèÔ∏è Corregir</button>
                  <button class="btn-danger" onclick="eliminarCostura(${r.id})">üóëÔ∏è Eliminar</button>
                </div>
              ` : `
                <div class="costura-info">
                  üí∞ Precio: <strong>$${r.pagoPorPieza.toFixed(2)}</strong> por pieza
                </div>
                <div class="precio-input">
                  <input 
                    type="number" 
                    id="precio-${r.id}" 
                    placeholder="Nuevo precio" 
                    step="0.01" 
                    min="0"
                    value="${r.pagoPorPieza}"
                  />
                  <button class="btn-secondary" onclick="asignarPrecio(${r.id})">‚úèÔ∏è Cambiar Precio</button>
                </div>
                <div class="costura-actions">
                  <button class="btn-edit" onclick="abrirModalEditar(${r.id})">‚úèÔ∏è Corregir Datos</button>
                  <button class="btn-danger" onclick="eliminarCostura(${r.id})">üóëÔ∏è Eliminar</button>
                </div>
              `}
            </div>
          `).join("");
        } catch (err) {
          mostrarError("Error cargando costuras: " + err.message);
        }
      }

      // ==========================================
      // FUNCIONES COMPARTIDAS
      // ==========================================
      async function cargarPedidosActivos(selectId) {
        try {
          const res = await fetch("/api/pedidos?estado=activo");
          if (!res.ok) throw new Error("Error al cargar pedidos");
          const pedidos = await res.json();
          
          const select = document.getElementById(selectId);
          select.innerHTML = '<option value="">-- Selecciona un pedido --</option>';
          
          pedidos.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = `${p.escuela} - ${p.folio}`;
            select.appendChild(opt);
          });
        } catch (err) {
          mostrarError("Error cargando pedidos: " + err.message);
        }
      }

      async function cargarMaquinas(selectId) {
        try {
          const res = await fetch("/api/maquinas");
          if (!res.ok) throw new Error("Error al cargar m√°quinas");
          const maquinas = await res.json();
          
          const select = document.getElementById(selectId);
          select.innerHTML = '<option value="">-- Selecciona una m√°quina --</option>';
          
          maquinas.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m;
            opt.textContent = m;
            select.appendChild(opt);
          });
        } catch (err) {
          mostrarError("Error cargando m√°quinas: " + err.message);
        }
      }

      async function cargarOperarias(selectId) {
        try {
          const res = await fetch("/api/operarias");
          if (!res.ok) throw new Error("Error al cargar operarias");
          const operarias = await res.json();
          
          const select = document.getElementById(selectId);
          select.innerHTML = '<option value="">-- Selecciona una operaria --</option>';
          
          operarias.filter(op => op.activa).forEach(op => {
            const opt = document.createElement("option");
            opt.value = op.id;
            opt.textContent = op.nombre;
            select.appendChild(opt);
          });
        } catch (err) {
          mostrarError("Error cargando operarias: " + err.message);
        }
      }

      // Funciones globales
      window.asignarPrecio = async function(registroId) {
        const input = document.getElementById(`precio-${registroId}`);
        const precio = Number(input.value);
        
        if (!precio || precio <= 0) {
          mostrarError("‚ùå Ingresa un precio v√°lido");
          return;
        }

        try {
          const resGet = await fetch(`/api/registros?estadoPago=todos`);
          const registros = await resGet.json();
          const registro = registros.find(r => r.id === registroId);
          
          if (!registro) throw new Error("Registro no encontrado");

          const resPut = await fetch(`/api/registros/${registroId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              pagoPorPieza: precio,
              totalGanado: registro.cantidad * precio
            })
          });

          if (!resPut.ok) throw new Error("Error al asignar precio");

          mostrarExito("‚úÖ Precio asignado correctamente");
          await cargarCosturasAdmin();
        } catch (err) {
          mostrarError("‚ùå " + err.message);
        }
      };

      window.eliminarCostura = async function(id) {
        if (!confirm("¬øEst√°s seguro de eliminar esta costura?")) return;

        try {
          const res = await fetch(`/api/registros/${id}`, { method: "DELETE" });
          if (!res.ok) throw new Error("Error al eliminar");

          mostrarExito("‚úÖ Costura eliminada");
          
          if (usuarioActual.tipo === "admin") {
            await cargarCosturasAdmin();
          } else {
            await cargarMisCosturas();
          }

          // Recargar faltantes en el dropdown de operaciones
          if (typeof window._recargarOperacionesOp === 'function') await window._recargarOperacionesOp();
          if (typeof window._recargarOperacionesEnc === 'function') await window._recargarOperacionesEnc();
        } catch (err) {
          mostrarError("‚ùå " + err.message);
        }
      };

      // Bot√≥n volver
      btnVolver.addEventListener("click", () => {
        window.location.href = "/dashboard";
      });

      // ==========================================
      // MODAL DE EDICI√ìN
      // ==========================================
      const modalEditar = document.getElementById("modal-editar");
      const btnCerrarModal = document.getElementById("btn-cerrar-modal");
      const btnCancelarEdit = document.getElementById("btn-cancelar-edit");
      const btnGuardarEdit = document.getElementById("btn-guardar-edit");
      const editPedido = document.getElementById("edit-pedido");
      const editMaquina = document.getElementById("edit-maquina");
      const editDescripcion = document.getElementById("edit-descripcion");
      const editCantidad = document.getElementById("edit-cantidad");

      let registroEditando = null;

      window.abrirModalEditar = async function(registroId) {
        try {
          // Obtener el registro completo
          const res = await fetch(`/api/registros?estadoPago=todos`);
          const registros = await res.json();
          registroEditando = registros.find(r => r.id === registroId);
          
          if (!registroEditando) {
            mostrarError("‚ùå Registro no encontrado");
            return;
          }

          // Cargar pedidos y m√°quinas en el modal
          await cargarPedidosEnModal();
          await cargarMaquinasEnModal();

          // Rellenar campos con datos actuales
          editPedido.value = registroEditando.pedidoId;
          editMaquina.value = registroEditando.maquina;
          editDescripcion.value = registroEditando.descripcion;
          editCantidad.value = registroEditando.cantidad;

          // Mostrar modal
          modalEditar.classList.add("active");
        } catch (err) {
          mostrarError("‚ùå Error al cargar datos: " + err.message);
        }
      };

      async function cargarPedidosEnModal() {
        try {
          const res = await fetch("/api/pedidos?estado=activo");
          if (!res.ok) throw new Error("Error al cargar pedidos");
          const pedidos = await res.json();
          
          editPedido.innerHTML = '<option value="">-- Selecciona un pedido --</option>';
          pedidos.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = `${p.escuela} - ${p.folio}`;
            editPedido.appendChild(opt);
          });
        } catch (err) {
          console.error("Error cargando pedidos:", err);
        }
      }

      async function cargarMaquinasEnModal() {
        try {
          const res = await fetch("/api/maquinas");
          if (!res.ok) throw new Error("Error al cargar m√°quinas");
          const maquinas = await res.json();
          
          editMaquina.innerHTML = '<option value="">-- Selecciona una m√°quina --</option>';
          maquinas.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m;
            opt.textContent = m;
            editMaquina.appendChild(opt);
          });
        } catch (err) {
          console.error("Error cargando m√°quinas:", err);
        }
      }

      function cerrarModal() {
        modalEditar.classList.remove("active");
        registroEditando = null;
        editPedido.value = "";
        editMaquina.value = "";
        editDescripcion.value = "";
        editCantidad.value = "";
      }

      btnCerrarModal.addEventListener("click", cerrarModal);
      btnCancelarEdit.addEventListener("click", cerrarModal);

      // Cerrar modal al hacer clic fuera
      modalEditar.addEventListener("click", (e) => {
        if (e.target === modalEditar) {
          cerrarModal();
        }
      });

      btnGuardarEdit.addEventListener("click", async () => {
        if (!registroEditando) return;

        const pedidoId = Number(editPedido.value);
        const maquina = editMaquina.value;
        const descripcion = editDescripcion.value.trim();
        const cantidad = Number(editCantidad.value);

        if (!pedidoId || !maquina || !descripcion || !cantidad || cantidad <= 0) {
          mostrarError("‚ùå Completa todos los campos correctamente");
          return;
        }

        btnGuardarEdit.disabled = true;
        btnGuardarEdit.textContent = "‚è≥ Guardando...";

        try {
          const res = await fetch(`/api/registros/${registroEditando.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              pedidoId,
              maquina,
              descripcion,
              cantidad
            })
          });

          if (!res.ok) throw new Error("Error al actualizar");

          mostrarExito("‚úÖ Costura actualizada correctamente");
          cerrarModal();

          // Recargar lista seg√∫n el rol
          if (usuarioActual.tipo === "admin") {
            await cargarCosturasAdmin();
          } else if (usuarioActual.tipo === "operaria") {
            await cargarMisCosturas();
          }

          // Recargar faltantes en el dropdown de operaciones
          if (typeof window._recargarOperacionesOp === 'function') await window._recargarOperacionesOp();
          if (typeof window._recargarOperacionesEnc === 'function') await window._recargarOperacionesEnc();

        } catch (err) {
          mostrarError("‚ùå " + err.message);
        } finally {
          btnGuardarEdit.disabled = false;
          btnGuardarEdit.textContent = "üíæ Guardar Cambios";
        }
      });
    });
  </script>
</body>
</html>
